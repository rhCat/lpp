{
  "$schema": "lpp/v0.1",
  "id": "readme_generator",
  "name": "L++ README Generator",
  "version": "1.0.0",
  "description": "Compiled L++ operator that generates README documentation from blueprints",

  "context_schema": {
    "properties": {
      "blueprint": { "type": "object", "description": "The blueprint to document" },
      "output_path": { "type": "string", "description": "Where to write the README" },
      "sections": { "type": "array", "description": "Accumulated markdown sections" },
      "mermaid": { "type": "string", "description": "Generated mermaid diagram" },
      "states_table": { "type": "string", "description": "Generated states table" },
      "gates_table": { "type": "string", "description": "Generated gates table" },
      "actions_table": { "type": "string", "description": "Generated actions table" },
      "transitions_table": { "type": "string", "description": "Generated transitions table" },
      "final_content": { "type": "string", "description": "Final assembled README" },
      "result": { "type": "string", "description": "Export result message" },
      "error": { "type": "string", "description": "Error if any" }
    }
  },

  "states": {
    "init": { "description": "Initial state, ready to receive blueprint" },
    "generating_header": { "description": "Generating title and metadata" },
    "generating_mermaid": { "description": "Generating state diagram" },
    "generating_tables": { "description": "Generating documentation tables" },
    "assembling": { "description": "Assembling final content" },
    "writing": { "description": "Writing to file" },
    "done": { "description": "Generation complete" },
    "error": { "description": "Error occurred" }
  },

  "entry_state": "init",
  "terminal_states": ["done", "error"],

  "gates": {
    "has_blueprint": { "type": "expression", "expression": "blueprint is not None" },
    "no_blueprint": { "type": "expression", "expression": "blueprint is None" },
    "has_output_path": { "type": "expression", "expression": "output_path is not None" },
    "has_states": { "type": "expression", "expression": "blueprint is not None and len(blueprint.get('states', {})) > 0" },
    "has_gates": { "type": "expression", "expression": "blueprint is not None and len(blueprint.get('gates', {})) > 0" },
    "has_transitions": { "type": "expression", "expression": "blueprint is not None and len(blueprint.get('transitions', [])) > 0" }
  },

  "actions": {
    "set_blueprint": {
      "type": "set",
      "target": "blueprint",
      "value_from": "event.payload.blueprint"
    },
    "set_output_path": {
      "type": "set",
      "target": "output_path",
      "value_from": "event.payload.path"
    },
    "generate_header": {
      "type": "compute",
      "compute_unit": "rdm:header",
      "input_map": { "blueprint": "blueprint" },
      "output_map": { "sections": "sections" }
    },
    "generate_mermaid": {
      "type": "compute",
      "compute_unit": "rdm:mermaid",
      "input_map": { "blueprint": "blueprint" },
      "output_map": { "mermaid": "mermaid" }
    },
    "generate_states_table": {
      "type": "compute",
      "compute_unit": "rdm:states_table",
      "input_map": { "blueprint": "blueprint" },
      "output_map": { "states_table": "table" }
    },
    "generate_gates_table": {
      "type": "compute",
      "compute_unit": "rdm:gates_table",
      "input_map": { "blueprint": "blueprint" },
      "output_map": { "gates_table": "table" }
    },
    "generate_actions_table": {
      "type": "compute",
      "compute_unit": "rdm:actions_table",
      "input_map": { "blueprint": "blueprint" },
      "output_map": { "actions_table": "table" }
    },
    "generate_transitions_table": {
      "type": "compute",
      "compute_unit": "rdm:transitions_table",
      "input_map": { "blueprint": "blueprint" },
      "output_map": { "transitions_table": "table" }
    },
    "assemble_readme": {
      "type": "compute",
      "compute_unit": "rdm:assemble",
      "input_map": {
        "sections": "sections",
        "mermaid": "mermaid",
        "states_table": "states_table",
        "gates_table": "gates_table",
        "actions_table": "actions_table",
        "transitions_table": "transitions_table"
      },
      "output_map": { "final_content": "content" }
    },
    "write_file": {
      "type": "compute",
      "compute_unit": "rdm:write",
      "input_map": {
        "content": "final_content",
        "path": "output_path"
      },
      "output_map": { "result": "result" }
    },
    "set_error": {
      "type": "set",
      "target": "error",
      "value_from": "event.payload.message"
    }
  },

  "transitions": [
    {
      "id": "t_start",
      "from": "init",
      "to": "generating_header",
      "on_event": "GENERATE",
      "gate": "has_blueprint",
      "actions": ["set_blueprint", "set_output_path", "generate_header"]
    },
    {
      "id": "t_no_blueprint",
      "from": "init",
      "to": "error",
      "on_event": "GENERATE",
      "gate": "no_blueprint",
      "actions": ["set_error"]
    },
    {
      "id": "t_to_mermaid",
      "from": "generating_header",
      "to": "generating_mermaid",
      "on_event": "NEXT",
      "actions": ["generate_mermaid"]
    },
    {
      "id": "t_to_tables",
      "from": "generating_mermaid",
      "to": "generating_tables",
      "on_event": "NEXT",
      "actions": ["generate_states_table", "generate_gates_table", "generate_actions_table", "generate_transitions_table"]
    },
    {
      "id": "t_to_assemble",
      "from": "generating_tables",
      "to": "assembling",
      "on_event": "NEXT",
      "actions": ["assemble_readme"]
    },
    {
      "id": "t_to_write",
      "from": "assembling",
      "to": "writing",
      "on_event": "NEXT",
      "gate": "has_output_path",
      "actions": ["write_file"]
    },
    {
      "id": "t_done",
      "from": "writing",
      "to": "done",
      "on_event": "NEXT",
      "actions": []
    }
  ]
}
