{
  "$schema": "lpp/v0.1.2",
  "id": "discovery_shopping",
  "name": "Fit-First Discovery Shopping",
  "version": "1.0.0",
  "description": "Quiz-driven product discovery with explainable matching and transparent rankings.",

  "context_schema": {
    "properties": {
      "category": { "type": "string", "description": "Product category (e.g., headphones)" },
      "quiz_questions": { "type": "array", "description": "Generated quiz questions" },
      "quiz_answers": { "type": "object", "description": "User answers keyed by question_id" },
      "preferences": { "type": "object", "description": "Extracted user preferences" },
      "products": { "type": "array", "description": "Fetched product list" },
      "reviews": { "type": "object", "description": "Aggregated review insights by product_id" },
      "rankings": { "type": "array", "description": "Ranked products with scores and reasons" },
      "comparison": { "type": "object", "description": "Side-by-side comparison result" },
      "selected_product": { "type": "string", "description": "Product ID user is viewing" },
      "alerts": { "type": "array", "description": "Price/restock alert subscriptions" },
      "affiliate_links": { "type": "object", "description": "Affiliate URLs by product_id" },
      "current_question_idx": { "type": "number", "description": "Quiz progress index" },
      "quiz_question_count": { "type": "number", "description": "Total quiz questions", "default": 0 },
      "has_category": { "type": "boolean", "description": "Category is set", "default": false },
      "quiz_complete": { "type": "boolean", "description": "All quiz questions answered", "default": false },
      "has_products": { "type": "boolean", "description": "Products fetched", "default": false },
      "has_rankings": { "type": "boolean", "description": "Rankings computed", "default": false },
      "has_selection": { "type": "boolean", "description": "Product selected", "default": false },
      "is_last_question": { "type": "boolean", "description": "About to answer last question", "default": false },
      "has_error": { "type": "boolean", "description": "Error occurred", "default": false },
      "error": { "type": "string" },
      "fetch_offset": { "type": "number", "description": "Current fetch offset", "default": 0 },
      "fetch_limit": { "type": "number", "description": "Products per batch", "default": 10 },
      "fetch_total": { "type": "number", "description": "Total products available", "default": 0 },
      "has_more_products": { "type": "boolean", "description": "More products to fetch", "default": false }
    }
  },

  "states": {
    "idle": { "description": "Awaiting category selection" },
    "quizzing": { "description": "Presenting preference quiz" },
    "fetching": { "description": "Fetching products from feeds" },
    "analyzing": { "description": "Aggregating review insights" },
    "ranking": { "description": "Scoring and ranking products" },
    "browsing": { "description": "User browsing ranked results" },
    "comparing": { "description": "Side-by-side comparison view" },
    "detail": { "description": "Single product detail view" },
    "alerting": { "description": "Setting up price/restock alert" },
    "error": { "description": "Error state" }
  },

  "entry_state": "idle",
  "terminal_states": [],

  "gates": {
    "has_category": {
      "type": "expression",
      "expression": "has_category == True"
    },
    "quiz_complete": {
      "type": "expression",
      "expression": "is_last_question == True"
    },
    "quiz_incomplete": {
      "type": "expression",
      "expression": "is_last_question == False"
    },
    "has_products": {
      "type": "expression",
      "expression": "has_products == True"
    },
    "has_rankings": {
      "type": "expression",
      "expression": "has_rankings == True"
    },
    "has_selection": {
      "type": "expression",
      "expression": "has_selection == True"
    },
    "has_error": {
      "type": "expression",
      "expression": "has_error == True"
    },
    "no_error": {
      "type": "expression",
      "expression": "has_error == False"
    }
  },

  "actions": {
    "set_category": {
      "type": "set",
      "target": "category",
      "value_from": "event.payload.category"
    },
    "generate_quiz": {
      "type": "compute",
      "compute_unit": "shop:generate_quiz",
      "input_map": { "category": "category" },
      "output_map": {
        "quiz_questions": "questions",
        "current_question_idx": "idx",
        "quiz_question_count": "question_count",
        "has_category": "has_category",
        "quiz_complete": "quiz_complete",
        "is_last_question": "is_last_question",
        "error": "error",
        "has_error": "has_error"
      }
    },
    "record_answer": {
      "type": "compute",
      "compute_unit": "shop:record_answer",
      "input_map": {
        "quiz_answers": "quiz_answers",
        "question_id": "event.payload.question_id",
        "answer": "event.payload.answer",
        "current_idx": "current_question_idx",
        "question_count": "quiz_question_count"
      },
      "output_map": {
        "quiz_answers": "answers",
        "current_question_idx": "idx",
        "quiz_complete": "quiz_complete",
        "is_last_question": "is_last_question"
      }
    },
    "extract_preferences": {
      "type": "compute",
      "compute_unit": "shop:extract_preferences",
      "input_map": {
        "quiz_questions": "quiz_questions",
        "quiz_answers": "quiz_answers"
      },
      "output_map": { "preferences": "preferences" }
    },
    "fetch_products": {
      "type": "compute",
      "compute_unit": "shop:fetch_products",
      "input_map": {
        "category": "category",
        "preferences": "preferences",
        "fetch_offset": "fetch_offset",
        "fetch_limit": "fetch_limit",
        "existing_products": "products",
        "existing_affiliate_links": "affiliate_links"
      },
      "output_map": {
        "products": "products",
        "affiliate_links": "affiliate_links",
        "has_products": "has_products",
        "fetch_offset": "fetch_offset",
        "fetch_total": "fetch_total",
        "has_more_products": "has_more_products",
        "has_error": "has_error",
        "error": "error"
      }
    },
    "fetch_more_products": {
      "type": "compute",
      "compute_unit": "shop:fetch_products",
      "input_map": {
        "category": "category",
        "preferences": "preferences",
        "fetch_offset": "fetch_offset",
        "fetch_limit": "fetch_limit",
        "existing_products": "products",
        "existing_affiliate_links": "affiliate_links"
      },
      "output_map": {
        "products": "products",
        "affiliate_links": "affiliate_links",
        "has_products": "has_products",
        "fetch_offset": "fetch_offset",
        "fetch_total": "fetch_total",
        "has_more_products": "has_more_products",
        "has_error": "has_error",
        "error": "error"
      }
    },
    "aggregate_reviews": {
      "type": "compute",
      "compute_unit": "shop:aggregate_reviews",
      "input_map": { "products": "products" },
      "output_map": {
        "reviews": "reviews",
        "has_error": "has_error",
        "error": "error"
      }
    },
    "rank_products": {
      "type": "compute",
      "compute_unit": "shop:rank_products",
      "input_map": {
        "products": "products",
        "preferences": "preferences",
        "reviews": "reviews"
      },
      "output_map": {
        "rankings": "rankings",
        "has_rankings": "has_rankings",
        "has_error": "has_error",
        "error": "error"
      }
    },
    "select_product": {
      "type": "set",
      "target": "selected_product",
      "value_from": "event.payload.product_id"
    },
    "set_has_selection": {
      "type": "set",
      "target": "has_selection",
      "value": true
    },
    "compare_products": {
      "type": "compute",
      "compute_unit": "shop:compare_products",
      "input_map": {
        "product_ids": "event.payload.product_ids",
        "products": "products",
        "reviews": "reviews",
        "preferences": "preferences"
      },
      "output_map": { "comparison": "comparison" }
    },
    "add_alert": {
      "type": "compute",
      "compute_unit": "shop:add_alert",
      "input_map": {
        "alerts": "alerts",
        "product_id": "event.payload.product_id",
        "alert_type": "event.payload.alert_type"
      },
      "output_map": { "alerts": "alerts" }
    },
    "clear_selection": {
      "type": "set",
      "target": "selected_product",
      "value": null
    },
    "clear_has_selection": {
      "type": "set",
      "target": "has_selection",
      "value": false
    },
    "clear_comparison": {
      "type": "set",
      "target": "comparison",
      "value": null
    },
    "set_error": {
      "type": "set",
      "target": "error",
      "value_from": "event.payload.message"
    },
    "set_has_error": {
      "type": "set",
      "target": "has_error",
      "value": true
    },
    "clear_error": {
      "type": "set",
      "target": "error",
      "value": null
    },
    "clear_has_error": {
      "type": "set",
      "target": "has_error",
      "value": false
    },
    "reset": {
      "type": "compute",
      "compute_unit": "shop:reset",
      "input_map": {},
      "output_map": {
        "category": "category",
        "quiz_questions": "quiz_questions",
        "quiz_answers": "quiz_answers",
        "preferences": "preferences",
        "products": "products",
        "reviews": "reviews",
        "rankings": "rankings",
        "comparison": "comparison",
        "selected_product": "selected_product",
        "alerts": "alerts",
        "current_question_idx": "current_question_idx",
        "quiz_question_count": "quiz_question_count",
        "has_category": "has_category",
        "quiz_complete": "quiz_complete",
        "is_last_question": "is_last_question",
        "has_products": "has_products",
        "has_rankings": "has_rankings",
        "has_selection": "has_selection",
        "has_error": "has_error",
        "fetch_offset": "fetch_offset",
        "fetch_total": "fetch_total",
        "has_more_products": "has_more_products"
      }
    }
  },

  "transitions": [
    {
      "id": "t_start",
      "from": "idle",
      "to": "quizzing",
      "on_event": "SELECT_CATEGORY",
      "actions": ["set_category", "generate_quiz"]
    },
    {
      "id": "t_answer",
      "from": "quizzing",
      "to": "quizzing",
      "on_event": "ANSWER",
      "gates": ["quiz_incomplete"],
      "actions": ["record_answer"]
    },
    {
      "id": "t_quiz_done",
      "from": "quizzing",
      "to": "fetching",
      "on_event": "ANSWER",
      "gates": ["quiz_complete"],
      "actions": ["record_answer", "extract_preferences", "fetch_products"]
    },
    {
      "id": "t_skip_quiz",
      "from": "quizzing",
      "to": "fetching",
      "on_event": "SKIP_QUIZ",
      "actions": ["extract_preferences", "fetch_products"]
    },
    {
      "id": "t_fetch_more",
      "from": "fetching",
      "to": "fetching",
      "on_event": "FETCH_MORE",
      "actions": ["fetch_more_products"]
    },
    {
      "id": "t_fetch_done",
      "from": "fetching",
      "to": "analyzing",
      "on_event": "DONE",
      "gates": ["has_products", "no_error"],
      "actions": ["aggregate_reviews"]
    },
    {
      "id": "t_fetch_error",
      "from": "fetching",
      "to": "error",
      "on_event": "DONE",
      "gates": ["has_error"]
    },
    {
      "id": "t_analyze_done",
      "from": "analyzing",
      "to": "ranking",
      "on_event": "DONE",
      "gates": ["no_error"],
      "actions": ["rank_products"]
    },
    {
      "id": "t_analyze_error",
      "from": "analyzing",
      "to": "error",
      "on_event": "DONE",
      "gates": ["has_error"]
    },
    {
      "id": "t_rank_done",
      "from": "ranking",
      "to": "browsing",
      "on_event": "DONE",
      "gates": ["has_rankings", "no_error"]
    },
    {
      "id": "t_rank_error",
      "from": "ranking",
      "to": "error",
      "on_event": "DONE",
      "gates": ["has_error"]
    },
    {
      "id": "t_view_detail",
      "from": "browsing",
      "to": "detail",
      "on_event": "VIEW",
      "actions": ["select_product", "set_has_selection"]
    },
    {
      "id": "t_start_compare",
      "from": "browsing",
      "to": "comparing",
      "on_event": "COMPARE",
      "actions": ["compare_products"]
    },
    {
      "id": "t_back_from_detail",
      "from": "detail",
      "to": "browsing",
      "on_event": "BACK",
      "actions": ["clear_selection", "clear_has_selection"]
    },
    {
      "id": "t_back_from_compare",
      "from": "comparing",
      "to": "browsing",
      "on_event": "BACK",
      "actions": ["clear_comparison"]
    },
    {
      "id": "t_detail_to_compare",
      "from": "detail",
      "to": "comparing",
      "on_event": "COMPARE",
      "actions": ["compare_products"]
    },
    {
      "id": "t_set_alert_from_detail",
      "from": "detail",
      "to": "alerting",
      "on_event": "SET_ALERT"
    },
    {
      "id": "t_set_alert_from_browse",
      "from": "browsing",
      "to": "alerting",
      "on_event": "SET_ALERT",
      "actions": ["select_product", "set_has_selection"]
    },
    {
      "id": "t_confirm_alert",
      "from": "alerting",
      "to": "detail",
      "on_event": "CONFIRM",
      "actions": ["add_alert"]
    },
    {
      "id": "t_cancel_alert",
      "from": "alerting",
      "to": "detail",
      "on_event": "CANCEL"
    },
    {
      "id": "t_new_search",
      "from": "browsing",
      "to": "idle",
      "on_event": "NEW_SEARCH",
      "actions": ["reset"]
    },
    {
      "id": "t_refine",
      "from": "browsing",
      "to": "quizzing",
      "on_event": "REFINE",
      "actions": ["generate_quiz"]
    },
    {
      "id": "t_recover",
      "from": "error",
      "to": "idle",
      "on_event": "RETRY",
      "actions": ["clear_error", "clear_has_error", "reset"]
    },
    {
      "id": "t_global_reset",
      "from": "*",
      "to": "idle",
      "on_event": "RESET",
      "actions": ["reset"]
    }
  ],

  "display": {
    "rules": [
      { "gate": "has_error", "template": "Error: {error}" },
      { "gate": "quiz_incomplete", "template": "Quiz Q{current_question_idx}/{len(quiz_questions)}" },
      { "gate": "has_rankings", "template": "{category}: {len(rankings)} matches" },
      { "gate": "has_selection", "template": "Viewing: {selected_product}" },
      { "template": "Discovery Shopping" }
    ]
  }
}
