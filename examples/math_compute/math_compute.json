{
  "$schema": "lpp/v0.1",
  "id": "calculator",
  "name": "L++ Calculator",
  "version": "2.0.0",

  "states": {
    "has_operand": { "description": "Has operand(s), waiting for operator or =" },
    "has_operator": { "description": "Has operator, waiting for next operand" },
    "error": { "description": "Error state" }
  },

  "entry_state": "has_operand",

  "gates": {
    "has_a": {
      "expression": "a is not None"
    },
    "has_b": {
      "expression": "b is not None"
    },
    "has_op": {
      "expression": "op in ('+', '-', '*', '/')"
    },
    "no_a": {
      "expression": "a is None"
    },
    "can_compute": {
      "expression": "a is not None and b is not None and op in ('+', '-', '*', '/')"
    },
    "is_div_zero": {
      "expression": "op == '/' and b == 0"
    },
    "safe_compute": {
      "expression": "a is not None and b is not None and op in ('+', '-', '*', '/') and not (op == '/' and b == 0)"
    }
  },

  "actions": {
    "set_a": {
      "type": "set",
      "target": "a",
      "value_from": "event.payload.value"
    },
    "set_b": {
      "type": "set",
      "target": "b",
      "value_from": "event.payload.value"
    },
    "set_operator": {
      "type": "set",
      "target": "op",
      "value_from": "event.payload.op"
    },
    "compute": {
      "type": "compute",
      "compute_unit": "math:calculate",
      "input_map": { "a": "a", "b": "b", "op": "op" },
      "output_map": { "a": "result" }
    },
    "clear_b": {
      "type": "set",
      "target": "b",
      "value": null
    },
    "clear_op": {
      "type": "set",
      "target": "op",
      "value": null
    },
    "set_error": {
      "type": "set",
      "target": "error",
      "value": "Division by zero"
    },
    "clear_a": {
      "type": "set",
      "target": "a",
      "value": null
    },
    "clear_error": {
      "type": "set",
      "target": "error",
      "value": null
    }
  },

  "transitions": [
    {
      "from": "has_operand",
      "to": "has_operator",
      "on_event": "OPERATOR",
      "actions": ["set_operator"]
    },
    {
      "from": "has_operator",
      "to": "has_operand",
      "on_event": "NUMBER",
      "actions": ["set_b"]
    },
    {
      "from": "has_operand",
      "to": "has_operand",
      "on_event": "NUMBER",
      "gates": ["no_a"],
      "actions": ["set_a"]
    },
    {
      "from": "has_operand",
      "to": "has_operand",
      "on_event": "EQUALS",
      "gates": ["safe_compute"],
      "actions": ["compute", "clear_b", "clear_op"]
    },
    {
      "from": "has_operand",
      "to": "error",
      "on_event": "EQUALS",
      "gates": ["is_div_zero"],
      "actions": ["set_error"]
    },
    {
      "from": "*",
      "to": "has_operand",
      "on_event": "CLEAR",
      "actions": ["clear_a", "clear_b", "clear_op", "clear_error"]
    }
  ],

  "context_schema": {
    "properties": {
      "a": { "type": "number", "description": "First operand / result" },
      "b": { "type": "number", "description": "Second operand" },
      "op": { "type": "string", "enum": ["+", "-", "*", "/"] },
      "error": { "type": "string" }
    }
  }
}
