{
  "$schema": "lpp/v0.2.0",
  "id": "auth_component",
  "name": "Authentication Component",
  "version": "1.0.0",
  "description": "Handles user authentication with credential validation",
  "context_schema": {
    "properties": {
      "username": {
        "type": "string"
      },
      "token": {
        "type": "string"
      },
      "user_id": {
        "type": "string"
      },
      "permissions": {
        "type": "array"
      },
      "error_code": {
        "type": "string"
      },
      "retry_allowed": {
        "type": "boolean"
      }
    }
  },
  "states": {
    "idle": {
      "name": "Idle",
      "description": "Awaiting credentials"
    },
    "validating": {
      "name": "Validating",
      "description": "Checking credentials"
    },
    "authenticated": {
      "name": "Authenticated",
      "description": "Successfully authenticated"
    },
    "auth_failed": {
      "name": "Failed",
      "description": "Authentication failed"
    }
  },
  "transitions": [
    {
      "id": "t_submit",
      "from": "idle",
      "to": "validating",
      "on_event": "SUBMIT",
      "actions": [
        "a_store_username"
      ]
    },
    {
      "id": "t_valid",
      "from": "validating",
      "to": "authenticated",
      "on_event": "VALIDATE",
      "gates": [
        "g_creds_valid"
      ],
      "actions": [
        "a_issue_token"
      ]
    },
    {
      "id": "t_invalid",
      "from": "validating",
      "to": "auth_failed",
      "on_event": "VALIDATE",
      "gates": [
        "g_creds_invalid"
      ],
      "actions": [
        "a_set_error"
      ]
    }
  ],
  "gates": {
    "g_creds_valid": {
      "type": "expression",
      "expression": "validation_result == 'valid'"
    },
    "g_creds_invalid": {
      "type": "expression",
      "expression": "validation_result != 'valid'"
    }
  },
  "actions": {
    "a_store_username": {
      "type": "set",
      "target": "username",
      "value_from": "event.payload.username"
    },
    "a_issue_token": {
      "type": "compute",
      "compute_unit": "auth:issue_token",
      "input_map": {
        "username": "username"
      },
      "output_map": {
        "token": "token",
        "user_id": "user_id",
        "permissions": "permissions"
      }
    },
    "a_set_error": {
      "type": "set",
      "target": "error_code",
      "value": "INVALID_CREDENTIALS"
    }
  },
  "entry_state": "idle",
  "terminal_states": {
    "authenticated": {
      "description": "User successfully authenticated",
      "output_schema": {
        "token": {
          "type": "string",
          "non_null": true
        },
        "user_id": {
          "type": "string",
          "non_null": true
        },
        "permissions": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      },
      "invariants_guaranteed": [
        "token_valid",
        "user_verified"
      ]
    },
    "auth_failed": {
      "description": "Authentication failed",
      "output_schema": {
        "error_code": {
          "type": "string",
          "non_null": true,
          "enum": [
            "INVALID_CREDENTIALS",
            "ACCOUNT_LOCKED",
            "ACCOUNT_EXPIRED"
          ]
        },
        "retry_allowed": {
          "type": "boolean",
          "non_null": true
        }
      },
      "invariants_guaranteed": [
        "no_token_issued",
        "attempt_logged"
      ]
    }
  }
}