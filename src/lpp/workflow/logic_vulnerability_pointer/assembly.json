{
  "$schema": "lpp/assembly/v0.1",
  "id": "lvp_assembly",
  "name": "Logic Vulnerability Pointer Assembly",
  "version": "1.0.0",
  "description": "Assembly orchestrating 6-phase security audit: X-Ray, Threat Model, Stress Test, Exploit Gen, Fix Gen, Report",
  "components": {
    "xray": {
      "blueprint": "xray.json",
      "required_terminals": ["done", "error"],
      "input_map": {
        "target_path": "assembly.context.target_path",
        "output_dir": "assembly.context.output_dir",
        "lpp_root": "assembly.context.lpp_root"
      }
    },
    "threat_model": {
      "blueprint": "threat_model.json",
      "required_terminals": ["done", "error"],
      "input_map": {
        "bone_json": "xray.output.bone_json",
        "target_name": "xray.output.target_name",
        "api_key": "assembly.context.api_key",
        "api_base": "assembly.context.api_base",
        "model": "assembly.context.model",
        "output_dir": "assembly.context.output_dir"
      }
    },
    "stress_test": {
      "blueprint": "stress_test.json",
      "required_terminals": ["vulnerable", "secure", "error"],
      "input_map": {
        "bone_json": "xray.output.bone_json",
        "invariants": "threat_model.output.invariants",
        "threat_model": "threat_model.output.threat_model",
        "output_dir": "assembly.context.output_dir",
        "lpp_root": "assembly.context.lpp_root",
        "api_key": "assembly.context.api_key",
        "api_base": "assembly.context.api_base",
        "model": "assembly.context.model"
      }
    },
    "exploit_gen": {
      "blueprint": "exploit_gen.json",
      "required_terminals": ["done", "error"],
      "input_map": {
        "counter_examples": "stress_test.output.counter_examples",
        "bone_json": "xray.output.bone_json",
        "target_path": "assembly.context.target_path",
        "target_name": "xray.output.target_name",
        "output_dir": "assembly.context.output_dir",
        "api_key": "assembly.context.api_key",
        "api_base": "assembly.context.api_base",
        "model": "assembly.context.model"
      }
    },
    "fix_gen": {
      "blueprint": "fix_gen.json",
      "required_terminals": ["verified", "unverified", "error"],
      "input_map": {
        "counter_examples": "stress_test.output.counter_examples",
        "bone_json": "xray.output.bone_json",
        "invariants": "threat_model.output.invariants",
        "output_dir": "assembly.context.output_dir",
        "lpp_root": "assembly.context.lpp_root",
        "api_key": "assembly.context.api_key",
        "api_base": "assembly.context.api_base",
        "model": "assembly.context.model"
      }
    },
    "report": {
      "blueprint": "report.json",
      "required_terminals": ["done", "error"],
      "input_map": {
        "target_name": "xray.output.target_name",
        "target_path": "assembly.context.target_path",
        "bone_json": "xray.output.bone_json",
        "threat_model": "threat_model.output.threat_model",
        "invariants": "threat_model.output.invariants",
        "counter_examples": "stress_test.output.counter_examples",
        "vulnerability_count": "stress_test.output.vulnerability_count",
        "exploits": "exploit_gen.output.exploits",
        "patches": "fix_gen.output.patches",
        "fix_verified": "fix_gen.output.fix_verified",
        "severity_score": "stress_test.output.severity_score",
        "output_dir": "assembly.context.output_dir",
        "run_id": "assembly.context.run_id"
      }
    }
  },
  "context_schema": {
    "properties": {
      "target_path": {
        "type": "string",
        "source": "input",
        "description": "Path to target Python file/project"
      },
      "output_dir": {
        "type": "string",
        "source": "input",
        "description": "Output directory for artifacts"
      },
      "run_id": {
        "type": "string",
        "source": "input",
        "description": "Unique audit run identifier"
      },
      "lpp_root": {
        "type": "string",
        "source": "input",
        "description": "L++ framework root"
      },
      "api_key": {
        "type": "string",
        "source": "input",
        "description": "LLM API key"
      },
      "api_base": {
        "type": "string",
        "source": "input",
        "description": "LLM API base URL"
      },
      "model": {
        "type": "string",
        "source": "input",
        "description": "LLM model identifier"
      },
      "auto_fix": {
        "type": "boolean",
        "source": "input",
        "description": "Auto-generate fixes if vulnerabilities found"
      },
      "bone_json": {
        "type": "object",
        "source": "xray.output.bone_json"
      },
      "target_name": {
        "type": "string",
        "source": "xray.output.target_name"
      },
      "invariants": {
        "type": "array",
        "source": "threat_model.output.invariants"
      },
      "counter_examples": {
        "type": "array",
        "source": "stress_test.output.counter_examples"
      },
      "vulnerability_count": {
        "type": "number",
        "source": "stress_test.output.vulnerability_count"
      },
      "severity_score": {
        "type": "number",
        "source": "stress_test.output.severity_score"
      },
      "exploits": {
        "type": "array",
        "source": "exploit_gen.output.exploits"
      },
      "patches": {
        "type": "array",
        "source": "fix_gen.output.patches"
      },
      "fix_verified": {
        "type": "boolean",
        "source": "fix_gen.output.fix_verified"
      },
      "audit_report": {
        "type": "object",
        "source": "report.output.audit_report"
      },
      "error_source": {
        "type": "string"
      },
      "error": {
        "type": "string"
      }
    }
  },
  "states": {
    "idle": {
      "type": "coordination",
      "description": "Awaiting audit request"
    },
    "phase_xray": {
      "type": "component_execution",
      "component": "xray",
      "description": "Phase 1: Extracting logic blueprint"
    },
    "phase_threat_model": {
      "type": "component_execution",
      "component": "threat_model",
      "description": "Phase 2: Defining safety invariants"
    },
    "phase_stress_test": {
      "type": "component_execution",
      "component": "stress_test",
      "description": "Phase 3: Running TLC model checker"
    },
    "phase_exploit_gen": {
      "type": "component_execution",
      "component": "exploit_gen",
      "description": "Phase 4: Generating exploit scripts"
    },
    "phase_fix_gen": {
      "type": "component_execution",
      "component": "fix_gen",
      "description": "Phase 5: Generating and verifying fix"
    },
    "phase_report": {
      "type": "component_execution",
      "component": "report",
      "description": "Phase 6: Generating audit report"
    },
    "complete": {
      "type": "coordination",
      "description": "Audit complete with vulnerabilities"
    },
    "secure": {
      "type": "coordination",
      "description": "Target passed all checks"
    },
    "error": {
      "type": "coordination",
      "description": "Audit failed"
    }
  },
  "transitions": [
    {
      "id": "t_start",
      "from": "idle",
      "to": "phase_xray",
      "on_event": "AUDIT",
      "gates": ["g_has_target"],
      "actions": ["a_init"]
    },
    {
      "id": "t_xray_done",
      "from": "phase_xray",
      "to": "phase_threat_model",
      "on_event": "xray:TERMINAL",
      "gates": ["g_xray_ok"],
      "actions": ["a_capture_bone"]
    },
    {
      "id": "t_xray_error",
      "from": "phase_xray",
      "to": "error",
      "on_event": "xray:TERMINAL",
      "gates": ["g_xray_error"],
      "actions": ["a_set_error_xray"]
    },
    {
      "id": "t_threat_done",
      "from": "phase_threat_model",
      "to": "phase_stress_test",
      "on_event": "threat_model:TERMINAL",
      "gates": ["g_threat_ok"],
      "actions": ["a_capture_invariants"]
    },
    {
      "id": "t_threat_error",
      "from": "phase_threat_model",
      "to": "error",
      "on_event": "threat_model:TERMINAL",
      "gates": ["g_threat_error"],
      "actions": ["a_set_error_threat"]
    },
    {
      "id": "t_stress_vulnerable",
      "from": "phase_stress_test",
      "to": "phase_exploit_gen",
      "on_event": "stress_test:TERMINAL",
      "gates": ["g_stress_vulnerable"],
      "actions": ["a_capture_vulns"]
    },
    {
      "id": "t_stress_secure",
      "from": "phase_stress_test",
      "to": "secure",
      "on_event": "stress_test:TERMINAL",
      "gates": ["g_stress_secure"]
    },
    {
      "id": "t_stress_error",
      "from": "phase_stress_test",
      "to": "error",
      "on_event": "stress_test:TERMINAL",
      "gates": ["g_stress_error"],
      "actions": ["a_set_error_stress"]
    },
    {
      "id": "t_exploit_to_fix",
      "from": "phase_exploit_gen",
      "to": "phase_fix_gen",
      "on_event": "exploit_gen:TERMINAL",
      "gates": ["g_exploit_ok", "g_auto_fix"],
      "actions": ["a_capture_exploits"]
    },
    {
      "id": "t_exploit_to_report",
      "from": "phase_exploit_gen",
      "to": "phase_report",
      "on_event": "exploit_gen:TERMINAL",
      "gates": ["g_exploit_ok", "g_no_auto_fix"],
      "actions": ["a_capture_exploits"]
    },
    {
      "id": "t_exploit_error",
      "from": "phase_exploit_gen",
      "to": "error",
      "on_event": "exploit_gen:TERMINAL",
      "gates": ["g_exploit_error"],
      "actions": ["a_set_error_exploit"]
    },
    {
      "id": "t_fix_to_report",
      "from": "phase_fix_gen",
      "to": "phase_report",
      "on_event": "fix_gen:TERMINAL",
      "gates": ["g_fix_done"],
      "actions": ["a_capture_fix"]
    },
    {
      "id": "t_fix_error",
      "from": "phase_fix_gen",
      "to": "phase_report",
      "on_event": "fix_gen:TERMINAL",
      "gates": ["g_fix_error"],
      "actions": ["a_clear_fix_error"]
    },
    {
      "id": "t_report_done",
      "from": "phase_report",
      "to": "complete",
      "on_event": "report:TERMINAL",
      "gates": ["g_report_ok"],
      "actions": ["a_capture_report"]
    },
    {
      "id": "t_report_error",
      "from": "phase_report",
      "to": "error",
      "on_event": "report:TERMINAL",
      "gates": ["g_report_error"],
      "actions": ["a_set_error_report"]
    }
  ],
  "gates": {
    "g_has_target": {
      "type": "expression",
      "expression": "target_path is not None"
    },
    "g_xray_ok": {
      "type": "expression",
      "expression": "xray._terminal == 'done'"
    },
    "g_xray_error": {
      "type": "expression",
      "expression": "xray._terminal == 'error'"
    },
    "g_threat_ok": {
      "type": "expression",
      "expression": "threat_model._terminal == 'done'"
    },
    "g_threat_error": {
      "type": "expression",
      "expression": "threat_model._terminal == 'error'"
    },
    "g_stress_vulnerable": {
      "type": "expression",
      "expression": "stress_test._terminal == 'vulnerable'"
    },
    "g_stress_secure": {
      "type": "expression",
      "expression": "stress_test._terminal == 'secure'"
    },
    "g_stress_error": {
      "type": "expression",
      "expression": "stress_test._terminal == 'error'"
    },
    "g_exploit_ok": {
      "type": "expression",
      "expression": "exploit_gen._terminal == 'done'"
    },
    "g_exploit_error": {
      "type": "expression",
      "expression": "exploit_gen._terminal == 'error'"
    },
    "g_auto_fix": {
      "type": "expression",
      "expression": "auto_fix == True"
    },
    "g_no_auto_fix": {
      "type": "expression",
      "expression": "auto_fix != True"
    },
    "g_fix_done": {
      "type": "expression",
      "expression": "fix_gen._terminal == 'verified' or fix_gen._terminal == 'unverified'"
    },
    "g_fix_error": {
      "type": "expression",
      "expression": "fix_gen._terminal == 'error'"
    },
    "g_report_ok": {
      "type": "expression",
      "expression": "report._terminal == 'done'"
    },
    "g_report_error": {
      "type": "expression",
      "expression": "report._terminal == 'error'"
    }
  },
  "actions": {
    "a_init": {
      "type": "compute",
      "compute_unit": "lvp:init",
      "input_map": {},
      "output_map": {
        "run_id": "run_id"
      }
    },
    "a_capture_bone": {
      "type": "set",
      "target": "bone_json",
      "value_from": "xray.output.bone_json"
    },
    "a_capture_invariants": {
      "type": "set",
      "target": "invariants",
      "value_from": "threat_model.output.invariants"
    },
    "a_capture_vulns": {
      "type": "set",
      "target": "counter_examples",
      "value_from": "stress_test.output.counter_examples"
    },
    "a_capture_exploits": {
      "type": "set",
      "target": "exploits",
      "value_from": "exploit_gen.output.exploits"
    },
    "a_capture_fix": {
      "type": "set",
      "target": "patches",
      "value_from": "fix_gen.output.patches"
    },
    "a_capture_report": {
      "type": "set",
      "target": "audit_report",
      "value_from": "report.output.audit_report"
    },
    "a_set_error_xray": {
      "type": "set",
      "target": "error_source",
      "value": "xray"
    },
    "a_set_error_threat": {
      "type": "set",
      "target": "error_source",
      "value": "threat_model"
    },
    "a_set_error_stress": {
      "type": "set",
      "target": "error_source",
      "value": "stress_test"
    },
    "a_set_error_exploit": {
      "type": "set",
      "target": "error_source",
      "value": "exploit_gen"
    },
    "a_set_error_report": {
      "type": "set",
      "target": "error_source",
      "value": "report"
    },
    "a_clear_fix_error": {
      "type": "set",
      "target": "error",
      "value": null
    }
  },
  "assembly_invariants": [
    {
      "id": "AI_001",
      "name": "Threat modeling requires bone",
      "type": "state_dependency",
      "expression": "_state == 'phase_threat_model' => bone_json != None",
      "severity": "critical",
      "description": "Cannot model threats without logic blueprint"
    },
    {
      "id": "AI_002",
      "name": "Stress test requires invariants",
      "type": "state_dependency",
      "expression": "_state == 'phase_stress_test' => invariants != None",
      "severity": "critical",
      "description": "Cannot stress test without safety invariants"
    },
    {
      "id": "AI_003",
      "name": "Exploit gen requires vulnerabilities",
      "type": "state_dependency",
      "expression": "_state == 'phase_exploit_gen' => counter_examples != None",
      "severity": "critical",
      "description": "Cannot generate exploits without counter-examples"
    },
    {
      "id": "AI_004",
      "name": "Sequential phase execution",
      "type": "sequence",
      "expression": "stress_test._terminal != None => threat_model._terminal == 'done'",
      "severity": "critical",
      "description": "Stress test can only complete after threat model succeeds"
    },
    {
      "id": "AI_005",
      "name": "Vulnerabilities lead to exploits or report",
      "type": "sequence",
      "expression": "(_state == 'complete') => (exploit_gen._terminal == 'done' or stress_test._terminal == 'secure')",
      "severity": "high",
      "description": "Completed audits must have generated exploits or found no vulnerabilities"
    }
  ],
  "entry_state": "idle",
  "terminal_states": {
    "complete": {},
    "secure": {},
    "error": {}
  }
}
