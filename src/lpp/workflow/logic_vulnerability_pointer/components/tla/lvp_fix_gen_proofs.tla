--------------------------- MODULE lvp_fix_gen_proofs ---------------------------
(*
 * L++ Blueprint: LVP Fix Generation Component
 * Version: 1.0.0
 * TLAPS Mathematical Proof
 *)

EXTENDS Naturals, TLAPS

CONSTANTS
    STATE_idle, STATE_generating_patches, STATE_verifying_tlaps, STATE_verified, STATE_unverified, STATE_error

ASSUME ConstantsDistinct ==
    /\ STATE_idle /= STATE_generating_patches
    /\ STATE_idle /= STATE_verifying_tlaps
    /\ STATE_idle /= STATE_verified
    /\ STATE_idle /= STATE_unverified
    /\ STATE_idle /= STATE_error
    /\ STATE_generating_patches /= STATE_verifying_tlaps
    /\ STATE_generating_patches /= STATE_verified
    /\ STATE_generating_patches /= STATE_unverified
    /\ STATE_generating_patches /= STATE_error
    /\ STATE_verifying_tlaps /= STATE_verified
    /\ STATE_verifying_tlaps /= STATE_unverified
    /\ STATE_verifying_tlaps /= STATE_error
    /\ STATE_verified /= STATE_unverified
    /\ STATE_verified /= STATE_error
    /\ STATE_unverified /= STATE_error

VARIABLE state

vars == <<state>>

States == {STATE_idle, STATE_generating_patches, STATE_verifying_tlaps, STATE_verified, STATE_unverified, STATE_error}
TerminalStates == {STATE_verified, STATE_unverified, STATE_error}

TypeInvariant == state \in States

Init == state = STATE_idle

(* Transition: t_start *)
t_t_start ==
    /\ state = STATE_idle
    /\ state' = STATE_generating_patches

(* Transition: t_patches_done *)
t_t_patches_done ==
    /\ state = STATE_generating_patches
    /\ state' = STATE_verifying_tlaps

(* Transition: t_patches_error *)
t_t_patches_error ==
    /\ state = STATE_generating_patches
    /\ state' = STATE_error

(* Transition: t_verified *)
t_t_verified ==
    /\ state = STATE_verifying_tlaps
    /\ state' = STATE_verified

(* Transition: t_unverified *)
t_t_unverified ==
    /\ state = STATE_verifying_tlaps
    /\ state' = STATE_unverified

(* Transition: t_verify_error *)
t_t_verify_error ==
    /\ state = STATE_verifying_tlaps
    /\ state' = STATE_error

Next ==
    \/ t_t_start
    \/ t_t_patches_done
    \/ t_t_patches_error
    \/ t_t_verified
    \/ t_t_unverified
    \/ t_t_verify_error

Spec == Init /\ [][Next]_vars

Inv == TypeInvariant

-----------------------------------------------------------------------------
(* TLAPS Proofs *)

LEMMA InitEstablishesInv == Init => Inv
BY DEF Init, Inv, TypeInvariant, States

LEMMA StartPreservesInv == Inv /\ t_t_start => Inv'
BY ConstantsDistinct DEF Inv, t_t_start, TypeInvariant, States

LEMMA PatchesDonePreservesInv == Inv /\ t_t_patches_done => Inv'
BY ConstantsDistinct DEF Inv, t_t_patches_done, TypeInvariant, States

LEMMA PatchesErrorPreservesInv == Inv /\ t_t_patches_error => Inv'
BY ConstantsDistinct DEF Inv, t_t_patches_error, TypeInvariant, States

LEMMA VerifiedPreservesInv == Inv /\ t_t_verified => Inv'
BY ConstantsDistinct DEF Inv, t_t_verified, TypeInvariant, States

LEMMA UnverifiedPreservesInv == Inv /\ t_t_unverified => Inv'
BY ConstantsDistinct DEF Inv, t_t_unverified, TypeInvariant, States

LEMMA VerifyErrorPreservesInv == Inv /\ t_t_verify_error => Inv'
BY ConstantsDistinct DEF Inv, t_t_verify_error, TypeInvariant, States

LEMMA StutterPreservesInv == Inv /\ UNCHANGED vars => Inv'
BY DEF Inv, vars, TypeInvariant

LEMMA NextPreservesInv == Inv /\ Next => Inv'
BY StartPreservesInv, PatchesDonePreservesInv, PatchesErrorPreservesInv, VerifiedPreservesInv, UnverifiedPreservesInv, VerifyErrorPreservesInv DEF Next

THEOREM InductiveInvariant == Inv /\ [Next]_vars => Inv'
BY NextPreservesInv, StutterPreservesInv DEF vars

THEOREM TypeSafety == Spec => []Inv
<1>1. Init => Inv
  BY InitEstablishesInv
<1>2. Inv /\ [Next]_vars => Inv'
  BY InductiveInvariant
<1>3. QED
  BY <1>1, <1>2, PTL DEF Spec

=============================================================================