{
  "$schema": "lpp/v0.1.2",
  "id": "lpp_blueprint_debugger",
  "name": "L++ Blueprint Debugger",
  "version": "1.0.0",
  "description": "Step-through debugging for L++ blueprints with breakpoints, inspection, and time-travel debugging",

  "context_schema": {
    "properties": {
      "blueprint": { "type": "object", "description": "The loaded blueprint object" },
      "blueprint_path": { "type": "string", "description": "Path to the loaded blueprint" },
      "blueprint_name": { "type": "string", "description": "Blueprint name" },
      "blueprint_id": { "type": "string", "description": "Blueprint ID" },
      "debug_state": { "type": "string", "description": "Current state in the debugged blueprint" },
      "debug_context": { "type": "object", "description": "Context of the debugged blueprint" },
      "breakpoints": { "type": "array", "description": "List of breakpoints" },
      "watches": { "type": "array", "description": "Watch expressions" },
      "watch_values": { "type": "object", "description": "Current watch values" },
      "history": { "type": "array", "description": "Execution history for time-travel" },
      "history_index": { "type": "number", "description": "Current position in history" },
      "available_events": { "type": "array", "description": "Events available in current state" },
      "available_transitions": { "type": "array", "description": "Transitions available from current state" },
      "last_transition": { "type": "object", "description": "Last executed transition details" },
      "last_gate_results": { "type": "object", "description": "Results of last gate evaluations" },
      "last_action_results": { "type": "array", "description": "Results of last action executions" },
      "is_paused": { "type": "boolean", "description": "Whether execution is paused" },
      "hit_breakpoint": { "type": "object", "description": "The breakpoint that was hit" },
      "output": { "type": "string", "description": "Display output" },
      "error": { "type": "string", "description": "Error message if any" }
    }
  },

  "states": {
    "idle": { "description": "No blueprint loaded, waiting for input" },
    "loaded": { "description": "Blueprint loaded, ready to debug" },
    "debugging": { "description": "Actively debugging, can step through execution" },
    "paused": { "description": "Paused at a breakpoint" },
    "error": { "description": "Error state" }
  },

  "entry_state": "idle",
  "terminal_states": [],

  "gates": {
    "has_blueprint": {
      "type": "expression",
      "expression": "blueprint is not None"
    },
    "no_blueprint": {
      "type": "expression",
      "expression": "blueprint is None"
    },
    "has_history": {
      "type": "expression",
      "expression": "history is not None and len(history) > 0"
    },
    "can_step_back": {
      "type": "expression",
      "expression": "history is not None and history_index > 0"
    },
    "can_step_forward": {
      "type": "expression",
      "expression": "history is not None and history_index < len(history) - 1"
    },
    "has_breakpoints": {
      "type": "expression",
      "expression": "breakpoints is not None and len(breakpoints) > 0"
    },
    "has_watches": {
      "type": "expression",
      "expression": "watches is not None and len(watches) > 0"
    },
    "is_at_terminal": {
      "type": "expression",
      "expression": "blueprint is not None and debug_state in blueprint.get('terminal_states', [])"
    },
    "is_paused_flag": {
      "type": "expression",
      "expression": "is_paused == True"
    },
    "is_not_paused": {
      "type": "expression",
      "expression": "is_paused != True"
    },
    "is_idle": {
      "type": "expression",
      "expression": "_state == 'idle'"
    },
    "is_loaded": {
      "type": "expression",
      "expression": "_state == 'loaded'"
    },
    "is_debugging": {
      "type": "expression",
      "expression": "_state == 'debugging'"
    },
    "is_paused_state": {
      "type": "expression",
      "expression": "_state == 'paused'"
    },
    "is_error": {
      "type": "expression",
      "expression": "_state == 'error'"
    }
  },

  "actions": {
    "load_blueprint": {
      "type": "compute",
      "compute_unit": "debug:load_blueprint",
      "input_map": { "path": "event.payload.path" },
      "output_map": {
        "blueprint": "blueprint",
        "blueprint_path": "blueprint_path",
        "blueprint_name": "blueprint_name",
        "blueprint_id": "blueprint_id",
        "error": "error"
      }
    },
    "init_debug_session": {
      "type": "compute",
      "compute_unit": "debug:init_debug_session",
      "input_map": { "blueprint": "blueprint" },
      "output_map": {
        "debug_state": "debug_state",
        "debug_context": "debug_context",
        "history": "history",
        "history_index": "history_index",
        "breakpoints": "breakpoints",
        "watches": "watches",
        "watch_values": "watch_values",
        "available_events": "available_events",
        "available_transitions": "available_transitions",
        "is_paused": "is_paused",
        "output": "output"
      }
    },
    "reset_session": {
      "type": "compute",
      "compute_unit": "debug:reset_session",
      "input_map": { "blueprint": "blueprint", "breakpoints": "breakpoints", "watches": "watches" },
      "output_map": {
        "debug_state": "debug_state",
        "debug_context": "debug_context",
        "history": "history",
        "history_index": "history_index",
        "available_events": "available_events",
        "available_transitions": "available_transitions",
        "is_paused": "is_paused",
        "output": "output"
      }
    },
    "set_breakpoint": {
      "type": "compute",
      "compute_unit": "debug:set_breakpoint",
      "input_map": {
        "breakpoints": "breakpoints",
        "bp_type": "event.payload.type",
        "target": "event.payload.target",
        "condition": "event.payload.condition"
      },
      "output_map": { "breakpoints": "breakpoints", "output": "output" }
    },
    "remove_breakpoint": {
      "type": "compute",
      "compute_unit": "debug:remove_breakpoint",
      "input_map": {
        "breakpoints": "breakpoints",
        "bp_id": "event.payload.bp_id"
      },
      "output_map": { "breakpoints": "breakpoints", "output": "output" }
    },
    "list_breakpoints": {
      "type": "compute",
      "compute_unit": "debug:list_breakpoints",
      "input_map": { "breakpoints": "breakpoints" },
      "output_map": { "output": "output" }
    },
    "step": {
      "type": "compute",
      "compute_unit": "debug:step",
      "input_map": {
        "blueprint": "blueprint",
        "debug_state": "debug_state",
        "debug_context": "debug_context",
        "history": "history",
        "history_index": "history_index",
        "breakpoints": "breakpoints",
        "watches": "watches",
        "event_name": "event.payload.event_name",
        "event_payload": "event.payload.payload"
      },
      "output_map": {
        "debug_state": "debug_state",
        "debug_context": "debug_context",
        "history": "history",
        "history_index": "history_index",
        "available_events": "available_events",
        "available_transitions": "available_transitions",
        "last_transition": "last_transition",
        "last_gate_results": "last_gate_results",
        "last_action_results": "last_action_results",
        "watch_values": "watch_values",
        "is_paused": "is_paused",
        "hit_breakpoint": "hit_breakpoint",
        "output": "output",
        "error": "error"
      }
    },
    "step_over": {
      "type": "compute",
      "compute_unit": "debug:step_over",
      "input_map": {
        "blueprint": "blueprint",
        "debug_state": "debug_state",
        "debug_context": "debug_context",
        "history": "history",
        "history_index": "history_index",
        "breakpoints": "breakpoints",
        "watches": "watches",
        "event_name": "event.payload.event_name",
        "event_payload": "event.payload.payload"
      },
      "output_map": {
        "debug_state": "debug_state",
        "debug_context": "debug_context",
        "history": "history",
        "history_index": "history_index",
        "available_events": "available_events",
        "available_transitions": "available_transitions",
        "last_transition": "last_transition",
        "watch_values": "watch_values",
        "is_paused": "is_paused",
        "hit_breakpoint": "hit_breakpoint",
        "output": "output",
        "error": "error"
      }
    },
    "step_back": {
      "type": "compute",
      "compute_unit": "debug:step_back",
      "input_map": {
        "history": "history",
        "history_index": "history_index",
        "blueprint": "blueprint",
        "watches": "watches"
      },
      "output_map": {
        "debug_state": "debug_state",
        "debug_context": "debug_context",
        "history_index": "history_index",
        "available_events": "available_events",
        "available_transitions": "available_transitions",
        "watch_values": "watch_values",
        "output": "output"
      }
    },
    "run_to_breakpoint": {
      "type": "compute",
      "compute_unit": "debug:run_to_breakpoint",
      "input_map": {
        "blueprint": "blueprint",
        "debug_state": "debug_state",
        "debug_context": "debug_context",
        "history": "history",
        "history_index": "history_index",
        "breakpoints": "breakpoints",
        "watches": "watches",
        "max_steps": "event.payload.max_steps"
      },
      "output_map": {
        "debug_state": "debug_state",
        "debug_context": "debug_context",
        "history": "history",
        "history_index": "history_index",
        "available_events": "available_events",
        "available_transitions": "available_transitions",
        "watch_values": "watch_values",
        "is_paused": "is_paused",
        "hit_breakpoint": "hit_breakpoint",
        "output": "output",
        "error": "error"
      }
    },
    "continue_execution": {
      "type": "compute",
      "compute_unit": "debug:continue_execution",
      "input_map": {
        "blueprint": "blueprint",
        "debug_state": "debug_state",
        "debug_context": "debug_context",
        "history": "history",
        "history_index": "history_index",
        "breakpoints": "breakpoints",
        "watches": "watches"
      },
      "output_map": {
        "debug_state": "debug_state",
        "debug_context": "debug_context",
        "history": "history",
        "history_index": "history_index",
        "available_events": "available_events",
        "available_transitions": "available_transitions",
        "watch_values": "watch_values",
        "is_paused": "is_paused",
        "hit_breakpoint": "hit_breakpoint",
        "output": "output",
        "error": "error"
      }
    },
    "pause_execution": {
      "type": "set",
      "target": "is_paused",
      "value": true
    },
    "resume_execution": {
      "type": "set",
      "target": "is_paused",
      "value": false
    },
    "inspect_state": {
      "type": "compute",
      "compute_unit": "debug:inspect_state",
      "input_map": {
        "blueprint": "blueprint",
        "debug_state": "debug_state",
        "available_transitions": "available_transitions"
      },
      "output_map": { "output": "output" }
    },
    "inspect_context": {
      "type": "compute",
      "compute_unit": "debug:inspect_context",
      "input_map": {
        "debug_context": "debug_context",
        "key": "event.payload.key"
      },
      "output_map": { "output": "output" }
    },
    "evaluate_expression": {
      "type": "compute",
      "compute_unit": "debug:evaluate_expression",
      "input_map": {
        "debug_context": "debug_context",
        "expression": "event.payload.expression"
      },
      "output_map": { "output": "output" }
    },
    "add_watch": {
      "type": "compute",
      "compute_unit": "debug:add_watch",
      "input_map": {
        "watches": "watches",
        "expression": "event.payload.expression",
        "name": "event.payload.name"
      },
      "output_map": { "watches": "watches", "output": "output" }
    },
    "remove_watch": {
      "type": "compute",
      "compute_unit": "debug:remove_watch",
      "input_map": {
        "watches": "watches",
        "watch_id": "event.payload.watch_id"
      },
      "output_map": { "watches": "watches", "output": "output" }
    },
    "get_watches": {
      "type": "compute",
      "compute_unit": "debug:get_watches",
      "input_map": {
        "watches": "watches",
        "watch_values": "watch_values",
        "debug_context": "debug_context"
      },
      "output_map": { "watch_values": "watch_values", "output": "output" }
    },
    "get_history": {
      "type": "compute",
      "compute_unit": "debug:get_history",
      "input_map": {
        "history": "history",
        "history_index": "history_index"
      },
      "output_map": { "output": "output" }
    },
    "goto_step": {
      "type": "compute",
      "compute_unit": "debug:goto_step",
      "input_map": {
        "history": "history",
        "target_step": "event.payload.step",
        "blueprint": "blueprint",
        "watches": "watches"
      },
      "output_map": {
        "debug_state": "debug_state",
        "debug_context": "debug_context",
        "history_index": "history_index",
        "available_events": "available_events",
        "available_transitions": "available_transitions",
        "watch_values": "watch_values",
        "output": "output"
      }
    },
    "compare_states": {
      "type": "compute",
      "compute_unit": "debug:compare_states",
      "input_map": {
        "history": "history",
        "step1": "event.payload.step1",
        "step2": "event.payload.step2"
      },
      "output_map": { "output": "output" }
    },
    "render_status": {
      "type": "compute",
      "compute_unit": "debug:render_status",
      "input_map": {
        "blueprint_name": "blueprint_name",
        "debug_state": "debug_state",
        "debug_context": "debug_context",
        "history_index": "history_index",
        "available_events": "available_events",
        "breakpoints": "breakpoints",
        "is_paused": "is_paused",
        "hit_breakpoint": "hit_breakpoint"
      },
      "output_map": { "output": "output" }
    },
    "set_error": {
      "type": "set",
      "target": "error",
      "value_from": "event.payload.message"
    },
    "clear_error": {
      "type": "set",
      "target": "error",
      "value": null
    },
    "clear_hit_breakpoint": {
      "type": "set",
      "target": "hit_breakpoint",
      "value": null
    },
    "unload_blueprint": {
      "type": "set",
      "target": "blueprint",
      "value": null
    }
  },

  "display": {
    "rules": [
      { "gate": "is_error", "template": "ERROR: {error}" },
      { "gate": "is_idle", "template": "No blueprint loaded. Use LOAD command." },
      { "gate": "is_paused_state", "template": "[PAUSED] {blueprint_name} @ {debug_state} (step {history_index})" },
      { "gate": "is_debugging", "template": "[DEBUG] {blueprint_name} @ {debug_state} (step {history_index})" },
      { "gate": "is_loaded", "template": "Loaded: {blueprint_name} - Ready to debug" },
      { "template": "L++ Blueprint Debugger" }
    ]
  },

  "transitions": [
    {
      "id": "t_load",
      "from": "idle",
      "to": "loaded",
      "on_event": "LOAD",
      "gates": ["no_blueprint"],
      "actions": ["load_blueprint"]
    },
    {
      "id": "t_load_error",
      "from": "idle",
      "to": "error",
      "on_event": "LOAD_FAILED",
      "actions": ["set_error"]
    },
    {
      "id": "t_reload",
      "from": "loaded",
      "to": "loaded",
      "on_event": "LOAD",
      "actions": ["load_blueprint"]
    },
    {
      "id": "t_reload_from_debug",
      "from": "debugging",
      "to": "loaded",
      "on_event": "LOAD",
      "actions": ["load_blueprint"]
    },
    {
      "id": "t_start_debug",
      "from": "loaded",
      "to": "debugging",
      "on_event": "START",
      "gates": ["has_blueprint"],
      "actions": ["init_debug_session", "render_status"]
    },
    {
      "id": "t_set_bp_loaded",
      "from": "loaded",
      "to": "loaded",
      "on_event": "SET_BREAKPOINT",
      "actions": ["set_breakpoint"]
    },
    {
      "id": "t_set_bp_debug",
      "from": "debugging",
      "to": "debugging",
      "on_event": "SET_BREAKPOINT",
      "actions": ["set_breakpoint"]
    },
    {
      "id": "t_set_bp_paused",
      "from": "paused",
      "to": "paused",
      "on_event": "SET_BREAKPOINT",
      "actions": ["set_breakpoint"]
    },
    {
      "id": "t_remove_bp_debug",
      "from": "debugging",
      "to": "debugging",
      "on_event": "REMOVE_BREAKPOINT",
      "actions": ["remove_breakpoint"]
    },
    {
      "id": "t_remove_bp_paused",
      "from": "paused",
      "to": "paused",
      "on_event": "REMOVE_BREAKPOINT",
      "actions": ["remove_breakpoint"]
    },
    {
      "id": "t_list_bp_debug",
      "from": "debugging",
      "to": "debugging",
      "on_event": "LIST_BREAKPOINTS",
      "actions": ["list_breakpoints"]
    },
    {
      "id": "t_list_bp_paused",
      "from": "paused",
      "to": "paused",
      "on_event": "LIST_BREAKPOINTS",
      "actions": ["list_breakpoints"]
    },
    {
      "id": "t_step",
      "from": "debugging",
      "to": "debugging",
      "on_event": "STEP",
      "gates": ["is_not_paused"],
      "actions": ["step"]
    },
    {
      "id": "t_step_to_paused",
      "from": "debugging",
      "to": "paused",
      "on_event": "STEP_HIT_BP",
      "actions": []
    },
    {
      "id": "t_step_over",
      "from": "debugging",
      "to": "debugging",
      "on_event": "STEP_OVER",
      "gates": ["is_not_paused"],
      "actions": ["step_over"]
    },
    {
      "id": "t_step_back",
      "from": "debugging",
      "to": "debugging",
      "on_event": "STEP_BACK",
      "gates": ["can_step_back"],
      "actions": ["step_back"]
    },
    {
      "id": "t_step_back_paused",
      "from": "paused",
      "to": "debugging",
      "on_event": "STEP_BACK",
      "gates": ["can_step_back"],
      "actions": ["step_back", "clear_hit_breakpoint"]
    },
    {
      "id": "t_run",
      "from": "debugging",
      "to": "debugging",
      "on_event": "RUN",
      "actions": ["run_to_breakpoint"]
    },
    {
      "id": "t_run_hit_bp",
      "from": "debugging",
      "to": "paused",
      "on_event": "RUN_HIT_BP",
      "actions": []
    },
    {
      "id": "t_continue",
      "from": "paused",
      "to": "debugging",
      "on_event": "CONTINUE",
      "actions": ["clear_hit_breakpoint", "resume_execution"]
    },
    {
      "id": "t_continue_run",
      "from": "paused",
      "to": "debugging",
      "on_event": "RUN",
      "actions": ["clear_hit_breakpoint", "continue_execution"]
    },
    {
      "id": "t_pause",
      "from": "debugging",
      "to": "paused",
      "on_event": "PAUSE",
      "actions": ["pause_execution"]
    },
    {
      "id": "t_stop",
      "from": "debugging",
      "to": "loaded",
      "on_event": "STOP",
      "actions": []
    },
    {
      "id": "t_stop_paused",
      "from": "paused",
      "to": "loaded",
      "on_event": "STOP",
      "actions": ["clear_hit_breakpoint"]
    },
    {
      "id": "t_inspect_state",
      "from": "debugging",
      "to": "debugging",
      "on_event": "INSPECT_STATE",
      "actions": ["inspect_state"]
    },
    {
      "id": "t_inspect_state_paused",
      "from": "paused",
      "to": "paused",
      "on_event": "INSPECT_STATE",
      "actions": ["inspect_state"]
    },
    {
      "id": "t_inspect_context",
      "from": "debugging",
      "to": "debugging",
      "on_event": "INSPECT_CONTEXT",
      "actions": ["inspect_context"]
    },
    {
      "id": "t_inspect_context_paused",
      "from": "paused",
      "to": "paused",
      "on_event": "INSPECT_CONTEXT",
      "actions": ["inspect_context"]
    },
    {
      "id": "t_eval",
      "from": "debugging",
      "to": "debugging",
      "on_event": "EVAL",
      "actions": ["evaluate_expression"]
    },
    {
      "id": "t_eval_paused",
      "from": "paused",
      "to": "paused",
      "on_event": "EVAL",
      "actions": ["evaluate_expression"]
    },
    {
      "id": "t_add_watch",
      "from": "debugging",
      "to": "debugging",
      "on_event": "ADD_WATCH",
      "actions": ["add_watch"]
    },
    {
      "id": "t_add_watch_paused",
      "from": "paused",
      "to": "paused",
      "on_event": "ADD_WATCH",
      "actions": ["add_watch"]
    },
    {
      "id": "t_remove_watch",
      "from": "debugging",
      "to": "debugging",
      "on_event": "REMOVE_WATCH",
      "actions": ["remove_watch"]
    },
    {
      "id": "t_get_watches",
      "from": "debugging",
      "to": "debugging",
      "on_event": "GET_WATCHES",
      "actions": ["get_watches"]
    },
    {
      "id": "t_get_watches_paused",
      "from": "paused",
      "to": "paused",
      "on_event": "GET_WATCHES",
      "actions": ["get_watches"]
    },
    {
      "id": "t_history",
      "from": "debugging",
      "to": "debugging",
      "on_event": "HISTORY",
      "actions": ["get_history"]
    },
    {
      "id": "t_history_paused",
      "from": "paused",
      "to": "paused",
      "on_event": "HISTORY",
      "actions": ["get_history"]
    },
    {
      "id": "t_goto_step",
      "from": "debugging",
      "to": "debugging",
      "on_event": "GOTO",
      "gates": ["has_history"],
      "actions": ["goto_step"]
    },
    {
      "id": "t_goto_step_paused",
      "from": "paused",
      "to": "debugging",
      "on_event": "GOTO",
      "gates": ["has_history"],
      "actions": ["goto_step", "clear_hit_breakpoint"]
    },
    {
      "id": "t_compare",
      "from": "debugging",
      "to": "debugging",
      "on_event": "COMPARE",
      "actions": ["compare_states"]
    },
    {
      "id": "t_compare_paused",
      "from": "paused",
      "to": "paused",
      "on_event": "COMPARE",
      "actions": ["compare_states"]
    },
    {
      "id": "t_reset",
      "from": "debugging",
      "to": "debugging",
      "on_event": "RESET",
      "actions": ["reset_session"]
    },
    {
      "id": "t_reset_paused",
      "from": "paused",
      "to": "debugging",
      "on_event": "RESET",
      "actions": ["reset_session", "clear_hit_breakpoint"]
    },
    {
      "id": "t_status",
      "from": "debugging",
      "to": "debugging",
      "on_event": "STATUS",
      "actions": ["render_status"]
    },
    {
      "id": "t_status_paused",
      "from": "paused",
      "to": "paused",
      "on_event": "STATUS",
      "actions": ["render_status"]
    },
    {
      "id": "t_unload",
      "from": "loaded",
      "to": "idle",
      "on_event": "UNLOAD",
      "actions": ["unload_blueprint"]
    },
    {
      "id": "t_unload_debug",
      "from": "debugging",
      "to": "idle",
      "on_event": "UNLOAD",
      "actions": ["unload_blueprint"]
    },
    {
      "id": "t_unload_paused",
      "from": "paused",
      "to": "idle",
      "on_event": "UNLOAD",
      "actions": ["unload_blueprint", "clear_hit_breakpoint"]
    },
    {
      "id": "t_recover",
      "from": "error",
      "to": "idle",
      "on_event": "CLEAR",
      "actions": ["clear_error"]
    }
  ]
}
