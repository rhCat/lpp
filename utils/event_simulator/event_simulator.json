{
  "$schema": "lpp/v0.1.2",
  "id": "lpp_event_simulator",
  "name": "L++ Event Sequence Simulator",
  "version": "1.0.0",
  "description": "Interactive simulation of L++ blueprints for what-if analysis and state space exploration",

  "context_schema": {
    "properties": {
      "blueprint": { "type": "object", "description": "The loaded blueprint object" },
      "blueprint_path": { "type": "string", "description": "Path to the loaded blueprint" },
      "blueprint_name": { "type": "string", "description": "Blueprint name" },
      "blueprint_id": { "type": "string", "description": "Blueprint ID" },
      "sim_state": { "type": "string", "description": "Current simulated state" },
      "sim_context": { "type": "object", "description": "Simulated context values" },
      "available_events": { "type": "array", "description": "Events available in current state" },
      "available_transitions": { "type": "array", "description": "Transitions available from current state" },
      "trace": { "type": "array", "description": "Execution trace history" },
      "forks": { "type": "object", "description": "Named simulation forks for what-if analysis" },
      "current_fork": { "type": "string", "description": "Name of current fork (null = main)" },
      "state_space": { "type": "object", "description": "Explored state space graph" },
      "path_result": { "type": "object", "description": "Result of path finding" },
      "fuzz_config": { "type": "object", "description": "Fuzzing configuration" },
      "fuzz_result": { "type": "object", "description": "Fuzzing run result" },
      "sequence": { "type": "array", "description": "Event sequence to execute" },
      "sequence_index": { "type": "number", "description": "Current position in sequence" },
      "mode": { "type": "string", "description": "Simulation mode: manual | sequence | fuzzing | replay" },
      "output": { "type": "string", "description": "Display output" },
      "error": { "type": "string", "description": "Error message if any" }
    }
  },

  "states": {
    "idle": { "description": "No blueprint loaded, waiting for input" },
    "ready": { "description": "Blueprint loaded, ready to simulate" },
    "simulating": { "description": "Actively simulating, can dispatch events" },
    "error": { "description": "Error state" }
  },

  "entry_state": "idle",
  "terminal_states": [],

  "gates": {
    "has_blueprint": {
      "type": "expression",
      "expression": "blueprint is not None"
    },
    "no_blueprint": {
      "type": "expression",
      "expression": "blueprint is None"
    },
    "has_trace": {
      "type": "expression",
      "expression": "trace is not None and len(trace) > 0"
    },
    "can_step_back": {
      "type": "expression",
      "expression": "trace is not None and len(trace) > 1"
    },
    "has_forks": {
      "type": "expression",
      "expression": "forks is not None and len(forks) > 0"
    },
    "has_sequence": {
      "type": "expression",
      "expression": "sequence is not None and len(sequence) > 0"
    },
    "sequence_not_done": {
      "type": "expression",
      "expression": "sequence is not None and sequence_index < len(sequence)"
    },
    "sequence_done": {
      "type": "expression",
      "expression": "sequence is None or sequence_index >= len(sequence)"
    },
    "has_state_space": {
      "type": "expression",
      "expression": "state_space is not None"
    },
    "has_path_result": {
      "type": "expression",
      "expression": "path_result is not None"
    },
    "is_idle": {
      "type": "expression",
      "expression": "_state == 'idle'"
    },
    "is_ready": {
      "type": "expression",
      "expression": "_state == 'ready'"
    },
    "is_simulating": {
      "type": "expression",
      "expression": "_state == 'simulating'"
    },
    "is_error": {
      "type": "expression",
      "expression": "_state == 'error'"
    },
    "can_import": {
      "type": "expression",
      "expression": "blueprint is not None"
    }
  },

  "actions": {
    "load_blueprint": {
      "type": "compute",
      "compute_unit": "sim:load_blueprint",
      "input_map": { "path": "event.payload.path" },
      "output_map": {
        "blueprint": "blueprint",
        "blueprint_path": "blueprint_path",
        "blueprint_name": "blueprint_name",
        "blueprint_id": "blueprint_id",
        "error": "error"
      }
    },
    "init_simulation": {
      "type": "compute",
      "compute_unit": "sim:init_simulation",
      "input_map": { "blueprint": "blueprint" },
      "output_map": {
        "sim_state": "sim_state",
        "sim_context": "sim_context",
        "available_events": "available_events",
        "available_transitions": "available_transitions",
        "trace": "trace",
        "forks": "forks",
        "current_fork": "current_fork",
        "mode": "mode"
      }
    },
    "set_context": {
      "type": "compute",
      "compute_unit": "sim:set_context",
      "input_map": {
        "sim_context": "sim_context",
        "key": "event.payload.key",
        "value": "event.payload.value"
      },
      "output_map": { "sim_context": "sim_context" }
    },
    "dispatch_event": {
      "type": "compute",
      "compute_unit": "sim:dispatch_event",
      "input_map": {
        "blueprint": "blueprint",
        "sim_state": "sim_state",
        "sim_context": "sim_context",
        "trace": "trace",
        "event_name": "event.payload.event_name",
        "event_payload": "event.payload.payload"
      },
      "output_map": {
        "sim_state": "sim_state",
        "sim_context": "sim_context",
        "trace": "trace",
        "available_events": "available_events",
        "available_transitions": "available_transitions",
        "output": "output",
        "error": "error"
      }
    },
    "get_available_events": {
      "type": "compute",
      "compute_unit": "sim:get_available_events",
      "input_map": {
        "blueprint": "blueprint",
        "sim_state": "sim_state",
        "sim_context": "sim_context"
      },
      "output_map": {
        "available_events": "available_events",
        "available_transitions": "available_transitions"
      }
    },
    "evaluate_gates": {
      "type": "compute",
      "compute_unit": "sim:evaluate_gates",
      "input_map": {
        "blueprint": "blueprint",
        "sim_context": "sim_context"
      },
      "output_map": { "output": "output" }
    },
    "fork_simulation": {
      "type": "compute",
      "compute_unit": "sim:fork_simulation",
      "input_map": {
        "forks": "forks",
        "fork_name": "event.payload.fork_name",
        "sim_state": "sim_state",
        "sim_context": "sim_context",
        "trace": "trace"
      },
      "output_map": {
        "forks": "forks",
        "current_fork": "current_fork",
        "output": "output"
      }
    },
    "switch_fork": {
      "type": "compute",
      "compute_unit": "sim:switch_fork",
      "input_map": {
        "forks": "forks",
        "fork_name": "event.payload.fork_name"
      },
      "output_map": {
        "sim_state": "sim_state",
        "sim_context": "sim_context",
        "trace": "trace",
        "current_fork": "current_fork",
        "available_events": "available_events",
        "available_transitions": "available_transitions",
        "output": "output",
        "error": "error"
      }
    },
    "step_back": {
      "type": "compute",
      "compute_unit": "sim:step_back",
      "input_map": {
        "trace": "trace",
        "blueprint": "blueprint"
      },
      "output_map": {
        "sim_state": "sim_state",
        "sim_context": "sim_context",
        "trace": "trace",
        "available_events": "available_events",
        "available_transitions": "available_transitions",
        "output": "output"
      }
    },
    "run_sequence": {
      "type": "compute",
      "compute_unit": "sim:run_sequence",
      "input_map": {
        "blueprint": "blueprint",
        "sim_state": "sim_state",
        "sim_context": "sim_context",
        "trace": "trace",
        "sequence": "sequence"
      },
      "output_map": {
        "sim_state": "sim_state",
        "sim_context": "sim_context",
        "trace": "trace",
        "sequence_index": "sequence_index",
        "available_events": "available_events",
        "available_transitions": "available_transitions",
        "output": "output",
        "error": "error"
      }
    },
    "set_sequence": {
      "type": "compute",
      "compute_unit": "sim:set_sequence",
      "input_map": { "events": "event.payload.events" },
      "output_map": {
        "sequence": "sequence",
        "sequence_index": "sequence_index",
        "mode": "mode"
      }
    },
    "fuzz_run": {
      "type": "compute",
      "compute_unit": "sim:fuzz_run",
      "input_map": {
        "blueprint": "blueprint",
        "sim_state": "sim_state",
        "sim_context": "sim_context",
        "trace": "trace",
        "steps": "event.payload.steps",
        "seed": "event.payload.seed"
      },
      "output_map": {
        "sim_state": "sim_state",
        "sim_context": "sim_context",
        "trace": "trace",
        "fuzz_result": "fuzz_result",
        "available_events": "available_events",
        "available_transitions": "available_transitions",
        "output": "output"
      }
    },
    "find_path": {
      "type": "compute",
      "compute_unit": "sim:find_path",
      "input_map": {
        "blueprint": "blueprint",
        "sim_state": "sim_state",
        "sim_context": "sim_context",
        "target_state": "event.payload.target_state"
      },
      "output_map": {
        "path_result": "path_result",
        "output": "output"
      }
    },
    "explore_state_space": {
      "type": "compute",
      "compute_unit": "sim:explore_state_space",
      "input_map": {
        "blueprint": "blueprint",
        "sim_state": "sim_state",
        "sim_context": "sim_context",
        "max_depth": "event.payload.max_depth"
      },
      "output_map": {
        "state_space": "state_space",
        "output": "output"
      }
    },
    "export_trace": {
      "type": "compute",
      "compute_unit": "sim:export_trace",
      "input_map": {
        "trace": "trace",
        "blueprint_id": "blueprint_id",
        "path": "event.payload.path"
      },
      "output_map": { "output": "output" }
    },
    "import_trace": {
      "type": "compute",
      "compute_unit": "sim:import_trace",
      "input_map": { "path": "event.payload.path" },
      "output_map": {
        "trace": "trace",
        "sequence": "sequence",
        "mode": "mode",
        "output": "output",
        "error": "error"
      }
    },
    "reset_simulation": {
      "type": "compute",
      "compute_unit": "sim:reset_simulation",
      "input_map": { "blueprint": "blueprint" },
      "output_map": {
        "sim_state": "sim_state",
        "sim_context": "sim_context",
        "trace": "trace",
        "available_events": "available_events",
        "available_transitions": "available_transitions",
        "mode": "mode",
        "output": "output"
      }
    },
    "render_status": {
      "type": "compute",
      "compute_unit": "sim:render_status",
      "input_map": {
        "blueprint_name": "blueprint_name",
        "sim_state": "sim_state",
        "sim_context": "sim_context",
        "available_events": "available_events",
        "trace": "trace",
        "mode": "mode",
        "current_fork": "current_fork"
      },
      "output_map": { "output": "output" }
    },
    "render_trace": {
      "type": "compute",
      "compute_unit": "sim:render_trace",
      "input_map": { "trace": "trace" },
      "output_map": { "output": "output" }
    },
    "render_state_space": {
      "type": "compute",
      "compute_unit": "sim:render_state_space",
      "input_map": { "state_space": "state_space" },
      "output_map": { "output": "output" }
    },
    "set_error": {
      "type": "set",
      "target": "error",
      "value_from": "event.payload.message"
    },
    "clear_error": {
      "type": "set",
      "target": "error",
      "value": null
    },
    "set_mode_manual": {
      "type": "set",
      "target": "mode",
      "value": "manual"
    },
    "set_mode_sequence": {
      "type": "set",
      "target": "mode",
      "value": "sequence"
    },
    "set_mode_fuzzing": {
      "type": "set",
      "target": "mode",
      "value": "fuzzing"
    },
    "set_mode_replay": {
      "type": "set",
      "target": "mode",
      "value": "replay"
    },
    "unload_blueprint": {
      "type": "set",
      "target": "blueprint",
      "value": null
    }
  },

  "display": {
    "rules": [
      { "gate": "is_error", "template": "ERROR: {error}" },
      { "gate": "is_idle", "template": "No blueprint loaded. Use LOAD command." },
      { "gate": "is_simulating", "template": "[{mode}] {blueprint_name} @ {sim_state}" },
      { "gate": "is_ready", "template": "Loaded: {blueprint_name} - Ready to simulate" },
      { "template": "L++ Event Simulator" }
    ]
  },

  "transitions": [
    {
      "id": "t_load",
      "from": "idle",
      "to": "ready",
      "on_event": "LOAD",
      "gates": ["no_blueprint"],
      "actions": ["load_blueprint"]
    },
    {
      "id": "t_load_error",
      "from": "idle",
      "to": "error",
      "on_event": "LOAD_FAILED",
      "actions": ["set_error"]
    },
    {
      "id": "t_reload",
      "from": "ready",
      "to": "ready",
      "on_event": "LOAD",
      "actions": ["load_blueprint"]
    },
    {
      "id": "t_reload_from_sim",
      "from": "simulating",
      "to": "ready",
      "on_event": "LOAD",
      "actions": ["load_blueprint"]
    },
    {
      "id": "t_start_simulation",
      "from": "ready",
      "to": "simulating",
      "on_event": "START",
      "gates": ["has_blueprint"],
      "actions": ["init_simulation", "render_status"]
    },
    {
      "id": "t_dispatch",
      "from": "simulating",
      "to": "simulating",
      "on_event": "DISPATCH",
      "actions": ["dispatch_event"]
    },
    {
      "id": "t_set_context",
      "from": "simulating",
      "to": "simulating",
      "on_event": "SET_CONTEXT",
      "actions": ["set_context", "get_available_events"]
    },
    {
      "id": "t_refresh_events",
      "from": "simulating",
      "to": "simulating",
      "on_event": "REFRESH",
      "actions": ["get_available_events", "render_status"]
    },
    {
      "id": "t_evaluate_gates",
      "from": "simulating",
      "to": "simulating",
      "on_event": "EVAL_GATES",
      "actions": ["evaluate_gates"]
    },
    {
      "id": "t_fork",
      "from": "simulating",
      "to": "simulating",
      "on_event": "FORK",
      "actions": ["fork_simulation"]
    },
    {
      "id": "t_switch_fork",
      "from": "simulating",
      "to": "simulating",
      "on_event": "SWITCH_FORK",
      "gates": ["has_forks"],
      "actions": ["switch_fork"]
    },
    {
      "id": "t_step_back",
      "from": "simulating",
      "to": "simulating",
      "on_event": "STEP_BACK",
      "gates": ["can_step_back"],
      "actions": ["step_back"]
    },
    {
      "id": "t_set_sequence",
      "from": "simulating",
      "to": "simulating",
      "on_event": "SET_SEQUENCE",
      "actions": ["set_sequence"]
    },
    {
      "id": "t_run_sequence",
      "from": "simulating",
      "to": "simulating",
      "on_event": "RUN_SEQUENCE",
      "gates": ["has_sequence"],
      "actions": ["run_sequence"]
    },
    {
      "id": "t_fuzz",
      "from": "simulating",
      "to": "simulating",
      "on_event": "FUZZ",
      "actions": ["fuzz_run"]
    },
    {
      "id": "t_find_path",
      "from": "simulating",
      "to": "simulating",
      "on_event": "FIND_PATH",
      "actions": ["find_path"]
    },
    {
      "id": "t_explore",
      "from": "simulating",
      "to": "simulating",
      "on_event": "EXPLORE",
      "actions": ["explore_state_space"]
    },
    {
      "id": "t_view_trace",
      "from": "simulating",
      "to": "simulating",
      "on_event": "VIEW_TRACE",
      "actions": ["render_trace"]
    },
    {
      "id": "t_view_space",
      "from": "simulating",
      "to": "simulating",
      "on_event": "VIEW_SPACE",
      "gates": ["has_state_space"],
      "actions": ["render_state_space"]
    },
    {
      "id": "t_export",
      "from": "simulating",
      "to": "simulating",
      "on_event": "EXPORT",
      "gates": ["has_trace"],
      "actions": ["export_trace"]
    },
    {
      "id": "t_import",
      "from": "simulating",
      "to": "simulating",
      "on_event": "IMPORT",
      "gates": ["can_import"],
      "actions": ["import_trace"]
    },
    {
      "id": "t_reset",
      "from": "simulating",
      "to": "simulating",
      "on_event": "RESET",
      "actions": ["reset_simulation"]
    },
    {
      "id": "t_back_to_ready",
      "from": "simulating",
      "to": "ready",
      "on_event": "STOP",
      "actions": []
    },
    {
      "id": "t_unload",
      "from": "ready",
      "to": "idle",
      "on_event": "UNLOAD",
      "actions": ["unload_blueprint"]
    },
    {
      "id": "t_unload_from_sim",
      "from": "simulating",
      "to": "idle",
      "on_event": "UNLOAD",
      "actions": ["unload_blueprint"]
    },
    {
      "id": "t_recover",
      "from": "error",
      "to": "idle",
      "on_event": "CLEAR",
      "actions": ["clear_error"]
    }
  ]
}
