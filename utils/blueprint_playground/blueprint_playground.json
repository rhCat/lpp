{
  "$schema": "lpp/v0.1.2",
  "id": "blueprint_playground",
  "name": "L++ Blueprint Playground",
  "version": "1.0.0",
  "description": "Interactive web-based environment for editing and testing L++ blueprints",
  "context_schema": {
    "properties": {
      "blueprint_json": {
        "type": "string",
        "description": "Raw JSON string of the blueprint being edited"
      },
      "blueprint": {
        "type": "object",
        "description": "Parsed blueprint object"
      },
      "blueprint_name": {
        "type": "string",
        "description": "Name of the loaded blueprint"
      },
      "validation_result": {
        "type": "object",
        "description": "JSON/schema validation result"
      },
      "is_valid_json": {
        "type": "boolean",
        "description": "Whether the JSON syntax is valid"
      },
      "is_valid_blueprint": {
        "type": "boolean",
        "description": "Whether the blueprint structure is valid"
      },
      "mermaid_diagram": {
        "type": "string",
        "description": "Generated Mermaid diagram code"
      },
      "sim_state": {
        "type": "string",
        "description": "Current simulation state"
      },
      "sim_context": {
        "type": "object",
        "description": "Current simulation context"
      },
      "available_events": {
        "type": "array",
        "description": "Events available in current simulation state"
      },
      "sim_trace": {
        "type": "array",
        "description": "Simulation execution trace"
      },
      "share_url": {
        "type": "string",
        "description": "Generated shareable URL"
      },
      "server_port": {
        "type": "number",
        "description": "Port the playground server is running on"
      },
      "output": {
        "type": "string",
        "description": "Last operation output message"
      },
      "error": {
        "type": "string",
        "description": "Error message if any"
      }
    }
  },
  "states": {
    "idle": {
      "description": "No blueprint loaded, waiting for input"
    },
    "editing": {
      "description": "Blueprint loaded and being edited"
    },
    "simulating": {
      "description": "Running interactive simulation"
    },
    "error": {
      "description": "Error state"
    }
  },
  "entry_state": "idle",
  "terminal_states": {},
  "gates": {
    "has_blueprint": {
      "type": "expression",
      "expression": "blueprint_json is not None and len(blueprint_json) > 0"
    },
    "no_blueprint": {
      "type": "expression",
      "expression": "blueprint_json is None or len(blueprint_json) == 0"
    },
    "is_valid_json": {
      "type": "expression",
      "expression": "is_valid_json is not None and is_valid_json == True"
    },
    "is_invalid_json": {
      "type": "expression",
      "expression": "is_valid_json is None or is_valid_json == False"
    },
    "is_valid_blueprint": {
      "type": "expression",
      "expression": "is_valid_blueprint is not None and is_valid_blueprint == True"
    },
    "has_simulation": {
      "type": "expression",
      "expression": "sim_state is not None"
    },
    "no_simulation": {
      "type": "expression",
      "expression": "sim_state is None"
    },
    "has_error": {
      "type": "expression",
      "expression": "error is not None"
    },
    "no_error": {
      "type": "expression",
      "expression": "error is None"
    },
    "has_permission": {
      "type": "expression",
      "expression": "True"
    }
  },
  "actions": {
    "load_blueprint": {
      "type": "compute",
      "compute_unit": "play:load_blueprint",
      "input_map": {
        "json_string": "event.payload.json_string",
        "file_path": "event.payload.file_path"
      },
      "output_map": {
        "blueprint_json": "blueprint_json",
        "blueprint": "blueprint",
        "blueprint_name": "blueprint_name",
        "is_valid_json": "is_valid_json",
        "error": "error"
      }
    },
    "validate_json": {
      "type": "compute",
      "compute_unit": "play:validate_json",
      "input_map": {
        "json_string": "blueprint_json"
      },
      "output_map": {
        "is_valid_json": "is_valid",
        "validation_result": "result",
        "error": "error"
      }
    },
    "validate_blueprint": {
      "type": "compute",
      "compute_unit": "play:validate_blueprint",
      "input_map": {
        "blueprint_json": "blueprint_json"
      },
      "output_map": {
        "is_valid_blueprint": "is_valid",
        "validation_result": "result",
        "error": "error"
      }
    },
    "format_blueprint": {
      "type": "compute",
      "compute_unit": "play:format_blueprint",
      "input_map": {
        "json_string": "blueprint_json"
      },
      "output_map": {
        "blueprint_json": "formatted",
        "output": "output"
      }
    },
    "generate_diagram": {
      "type": "compute",
      "compute_unit": "play:generate_diagram",
      "input_map": {
        "blueprint": "blueprint"
      },
      "output_map": {
        "mermaid_diagram": "mermaid"
      }
    },
    "init_simulation": {
      "type": "compute",
      "compute_unit": "play:init_simulation",
      "input_map": {
        "blueprint": "blueprint"
      },
      "output_map": {
        "sim_state": "sim_state",
        "sim_context": "sim_context",
        "available_events": "available_events",
        "sim_trace": "trace",
        "output": "output"
      }
    },
    "dispatch_event": {
      "type": "compute",
      "compute_unit": "play:dispatch_event",
      "input_map": {
        "blueprint": "blueprint",
        "sim_state": "sim_state",
        "sim_context": "sim_context",
        "sim_trace": "sim_trace",
        "event_name": "event.payload.event_name",
        "event_payload": "event.payload.event_payload"
      },
      "output_map": {
        "sim_state": "sim_state",
        "sim_context": "sim_context",
        "available_events": "available_events",
        "sim_trace": "trace",
        "output": "output",
        "error": "error"
      }
    },
    "get_available_events": {
      "type": "compute",
      "compute_unit": "play:get_available_events",
      "input_map": {
        "blueprint": "blueprint",
        "sim_state": "sim_state",
        "sim_context": "sim_context"
      },
      "output_map": {
        "available_events": "events"
      }
    },
    "encode_share_url": {
      "type": "compute",
      "compute_unit": "play:encode_share_url",
      "input_map": {
        "blueprint_json": "blueprint_json",
        "base_url": "event.payload.base_url"
      },
      "output_map": {
        "share_url": "url",
        "output": "output"
      }
    },
    "decode_share_url": {
      "type": "compute",
      "compute_unit": "play:decode_share_url",
      "input_map": {
        "url": "event.payload.url"
      },
      "output_map": {
        "blueprint_json": "blueprint_json",
        "blueprint": "blueprint",
        "blueprint_name": "blueprint_name",
        "is_valid_json": "is_valid_json",
        "output": "output",
        "error": "error"
      }
    },
    "export_blueprint": {
      "type": "compute",
      "compute_unit": "play:export_blueprint",
      "input_map": {
        "blueprint_json": "blueprint_json",
        "file_path": "event.payload.file_path"
      },
      "output_map": {
        "output": "output",
        "error": "error"
      }
    },
    "update_blueprint": {
      "type": "set",
      "target": "blueprint_json",
      "value_from": "event.payload.json_string"
    },
    "clear_blueprint": {
      "type": "set",
      "target": "blueprint_json",
      "value": null
    },
    "clear_simulation": {
      "type": "set",
      "target": "sim_state",
      "value": null
    },
    "set_error": {
      "type": "set",
      "target": "error",
      "value_from": "event.payload.message"
    },
    "clear_error": {
      "type": "set",
      "target": "error",
      "value": null
    },
    "log_update": {
      "type": "set",
      "target": "output",
      "value": "Blueprint updated"
    }
  },
  "display": {
    "rules": [
      {
        "gate": "has_error",
        "template": "ERROR: {error}"
      },
      {
        "gate": "no_blueprint",
        "template": "No blueprint loaded. Use LOAD or paste JSON."
      },
      {
        "gate": "has_simulation",
        "template": "[SIM] {blueprint_name} | State: {sim_state}"
      },
      {
        "gate": "has_blueprint",
        "template": "[EDIT] {blueprint_name} | Valid: {is_valid_blueprint}"
      },
      {
        "template": "L++ Blueprint Playground"
      }
    ]
  },
  "transitions": [
    {
      "id": "t_load_from_idle",
      "from": "idle",
      "to": "editing",
      "on_event": "LOAD",
      "actions": [
        "load_blueprint",
        "validate_blueprint",
        "generate_diagram"
      ]
    },
    {
      "id": "t_load_from_url",
      "from": "idle",
      "to": "editing",
      "on_event": "LOAD_FROM_URL",
      "actions": [
        "decode_share_url",
        "validate_blueprint",
        "generate_diagram"
      ]
    },
    {
      "id": "t_reload",
      "from": "editing",
      "to": "editing",
      "on_event": "LOAD",
      "actions": [
        "load_blueprint",
        "validate_blueprint",
        "generate_diagram"
      ]
    },
    {
      "id": "t_update",
      "from": "editing",
      "to": "editing",
      "on_event": "UPDATE",
      "gates": [
        "has_permission"
      ],
      "actions": [
        "update_blueprint",
        "validate_json",
        "log_update"
      ]
    },
    {
      "id": "t_validate",
      "from": "editing",
      "to": "editing",
      "on_event": "VALIDATE",
      "gates": [
        "has_blueprint"
      ],
      "actions": [
        "validate_json",
        "validate_blueprint"
      ]
    },
    {
      "id": "t_format",
      "from": "editing",
      "to": "editing",
      "on_event": "FORMAT",
      "gates": [
        "has_blueprint",
        "is_valid_json"
      ],
      "actions": [
        "format_blueprint",
        "validate_blueprint",
        "generate_diagram"
      ]
    },
    {
      "id": "t_regenerate_diagram",
      "from": "editing",
      "to": "editing",
      "on_event": "REGENERATE_DIAGRAM",
      "gates": [
        "has_blueprint",
        "is_valid_blueprint"
      ],
      "actions": [
        "generate_diagram"
      ]
    },
    {
      "id": "t_start_simulation",
      "from": "editing",
      "to": "simulating",
      "on_event": "START_SIM",
      "gates": [
        "has_blueprint",
        "is_valid_blueprint"
      ],
      "actions": [
        "init_simulation"
      ]
    },
    {
      "id": "t_dispatch_event",
      "from": "simulating",
      "to": "simulating",
      "on_event": "DISPATCH",
      "gates": [
        "has_simulation"
      ],
      "actions": [
        "dispatch_event",
        "get_available_events"
      ]
    },
    {
      "id": "t_reset_simulation",
      "from": "simulating",
      "to": "simulating",
      "on_event": "RESET_SIM",
      "actions": [
        "init_simulation"
      ]
    },
    {
      "id": "t_stop_simulation",
      "from": "simulating",
      "to": "editing",
      "on_event": "STOP_SIM",
      "actions": [
        "clear_simulation"
      ]
    },
    {
      "id": "t_share",
      "from": "editing",
      "to": "editing",
      "on_event": "SHARE",
      "gates": [
        "has_blueprint"
      ],
      "actions": [
        "encode_share_url"
      ]
    },
    {
      "id": "t_share_from_sim",
      "from": "simulating",
      "to": "simulating",
      "on_event": "SHARE",
      "gates": [
        "has_blueprint"
      ],
      "actions": [
        "encode_share_url"
      ]
    },
    {
      "id": "t_export",
      "from": "editing",
      "to": "editing",
      "on_event": "EXPORT",
      "gates": [
        "has_blueprint"
      ],
      "actions": [
        "export_blueprint"
      ]
    },
    {
      "id": "t_export_from_sim",
      "from": "simulating",
      "to": "simulating",
      "on_event": "EXPORT",
      "gates": [
        "has_blueprint"
      ],
      "actions": [
        "export_blueprint"
      ]
    },
    {
      "id": "t_unload",
      "from": "editing",
      "to": "idle",
      "on_event": "UNLOAD",
      "actions": [
        "clear_blueprint",
        "clear_simulation"
      ]
    },
    {
      "id": "t_unload_from_sim",
      "from": "simulating",
      "to": "idle",
      "on_event": "UNLOAD",
      "actions": [
        "clear_blueprint",
        "clear_simulation"
      ]
    },
    {
      "id": "t_error_from_editing",
      "from": "editing",
      "to": "error",
      "on_event": "ERROR",
      "actions": [
        "set_error"
      ]
    },
    {
      "id": "t_error_from_simulating",
      "from": "simulating",
      "to": "error",
      "on_event": "ERROR",
      "actions": [
        "set_error"
      ]
    },
    {
      "id": "t_recover",
      "from": "error",
      "to": "idle",
      "on_event": "CLEAR",
      "actions": [
        "clear_error",
        "clear_blueprint",
        "clear_simulation"
      ]
    },
    {
      "id": "t_recover_to_editing",
      "from": "error",
      "to": "editing",
      "on_event": "RETRY",
      "gates": [
        "has_blueprint"
      ],
      "actions": [
        "clear_error"
      ]
    }
  ]
}