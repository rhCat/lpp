flowchart TD
    %% L++ Logic CAD: L++ Blueprint Composer
        state_idle(["idle<br>No blueprints loaded, waiting for input"]):::entry
        state_validated(["validated<br>Validation complete, results available"]):::state
    subgraph Processing
        state_composed(["composed<br>Composition complete, ready to validate "]):::state
        state_parent_loaded(["parent_loaded<br>Parent blueprint loaded, waiting for chi"]):::state
        state_embedding_ready(["embedding_ready<br>Embedding defined, ready to compose or a"]):::state
        state_child_loaded(["child_loaded<br>Both parent and child loaded, ready to d"]):::state
        state_defining_embedding(["defining_embedding<br>Defining embedding parameters (target st"]):::state
    end

    %% Transitions
    act_t0s0[["load_parent"]]:::action
    state_idle -- "LOAD_PARENT" --> act_t0s0
    act_t0s0 --> state_parent_loaded
    act_t1s0[["load_manifest, compose_from_manifest"]]:::action
    state_idle -- "LOAD_MANIFEST" --> act_t1s0
    act_t1s0 --> state_composed
    gate_t2s0{{"parent_blueprint is not None?"}}:::gate
    state_parent_loaded -- "LOAD_CHILD" --> gate_t2s0
    act_t2s0[["load_child"]]:::action
    gate_t2s0 -- ✓ --> act_t2s0
    act_t2s0 --> state_child_loaded
    act_t3s0[["load_parent, clear_embeddings"]]:::action
    state_parent_loaded -- "LOAD_PARENT" --> act_t3s0
    act_t3s0 --> state_parent_loaded
    act_t4s0[["load_child"]]:::action
    state_child_loaded -- "LOAD_CHILD" --> act_t4s0
    act_t4s0 --> state_child_loaded
    gate_t5s0{{"parent_blueprint is not Non...?"}}:::gate
    state_child_loaded -- "DEFINE" --> gate_t5s0
    act_t5s0[["init_embedding"]]:::action
    gate_t5s0 -- ✓ --> act_t5s0
    act_t5s0 --> state_defining_embedding
    gate_t6s0{{"current_embedding is not None?"}}:::gate
    state_defining_embedding -- "SET_INPUT" --> gate_t6s0
    act_t6s0[["set_input_contract"]]:::action
    gate_t6s0 -- ✓ --> act_t6s0
    act_t6s0 --> state_defining_embedding
    gate_t7s0{{"current_embedding is not None?"}}:::gate
    state_defining_embedding -- "SET_OUTPUT" --> gate_t7s0
    act_t7s0[["set_output_contract"]]:::action
    gate_t7s0 -- ✓ --> act_t7s0
    act_t7s0 --> state_defining_embedding
    gate_t8s0{{"current_embedding is not None?"}}:::gate
    state_defining_embedding -- "SET_EVENTS" --> gate_t8s0
    act_t8s0[["set_event_map"]]:::action
    gate_t8s0 -- ✓ --> act_t8s0
    act_t8s0 --> state_defining_embedding
    gate_t9s0{{"current_embedding is not None?"}}:::gate
    state_defining_embedding -- "DONE" --> gate_t9s0
    act_t9s0[["finalize_embedding"]]:::action
    gate_t9s0 -- ✓ --> act_t9s0
    act_t9s0 --> state_embedding_ready
    act_t10s0[["clear_child"]]:::action
    state_embedding_ready -- "ADD_MORE" --> act_t10s0
    act_t10s0 --> state_child_loaded
    gate_t11s0{{"embeddings is not None and ...?"}}:::gate
    state_embedding_ready -- "COMPOSE" --> gate_t11s0
    act_t11s0[["compose"]]:::action
    gate_t11s0 -- ✓ --> act_t11s0
    act_t11s0 --> state_composed
    gate_t12s0{{"parent_blueprint is not Non...?"}}:::gate
    state_child_loaded -- "QUICK_COMPOSE" --> gate_t12s0
    act_t12s0[["init_embedding, finalize_embedding, compose"]]:::action
    gate_t12s0 -- ✓ --> act_t12s0
    act_t12s0 --> state_composed
    gate_t13s0{{"composed_blueprint is not None?"}}:::gate
    state_composed -- "VALIDATE" --> gate_t13s0
    act_t13s0[["validate_composition"]]:::action
    gate_t13s0 -- ✓ --> act_t13s0
    act_t13s0 --> state_validated
    gate_t14s0{{"composed_blueprint is not None?"}}:::gate
    state_composed -- "FLATTEN" --> gate_t14s0
    act_t14s0[["flatten"]]:::action
    gate_t14s0 -- ✓ --> act_t14s0
    act_t14s0 --> state_composed
    gate_t15s0{{"composed_blueprint is not None?"}}:::gate
    state_composed -- "EXPORT" --> gate_t15s0
    act_t15s0[["export_composed"]]:::action
    gate_t15s0 -- ✓ --> act_t15s0
    act_t15s0 --> state_composed
    gate_t16s0{{"composed_blueprint is not None?"}}:::gate
    state_validated -- "EXPORT" --> gate_t16s0
    act_t16s0[["export_composed"]]:::action
    gate_t16s0 -- ✓ --> act_t16s0
    act_t16s0 --> state_validated
    gate_t17s0{{"embeddings is not None and ... && parent_blueprint is not Non...?"}}:::gate
    state_embedding_ready -- "SAVE_MANIFEST" --> gate_t17s0
    act_t17s0[["generate_manifest, export_manifest"]]:::action
    gate_t17s0 -- ✓ --> act_t17s0
    act_t17s0 --> state_embedding_ready
    gate_t18s0{{"composed_blueprint is not None?"}}:::gate
    state_validated -- "VALIDATE" --> gate_t18s0
    act_t18s0[["validate_composition"]]:::action
    gate_t18s0 -- ✓ --> act_t18s0
    act_t18s0 --> state_validated
    state_validated -- "BACK" --> state_composed
    act_t20s0[["clear_composed"]]:::action
    state_composed -- "BACK" --> act_t20s0
    act_t20s0 --> state_embedding_ready
    state_defining_embedding -- "CANCEL" --> state_child_loaded
    act_t22s0[["clear_all"]]:::action
    state_composed -- "RESET" --> act_t22s0
    act_t22s0 --> state_idle
    act_t23s0[["clear_all"]]:::action
    state_validated -- "RESET" --> act_t23s0
    act_t23s0 --> state_idle
    act_t24s0[["clear_all"]]:::action
    state_parent_loaded -- "CLEAR" --> act_t24s0
    act_t24s0 --> state_idle
    act_t25s0[["clear_all"]]:::action
    state_child_loaded -- "CLEAR" --> act_t25s0
    act_t25s0 --> state_idle

    %% Styling - ALL shapes have explicit fill and black text
    classDef entry fill:#e1f5fe,stroke:#01579b,stroke-width:3px,color:#000
    classDef terminal fill:#c8e6c9,stroke:#2e7d32,stroke-width:3px,color:#000
    classDef errorState fill:#ffcdd2,stroke:#c62828,stroke-width:2px,color:#000
    classDef state fill:#ffffff,stroke:#6a6aaa,stroke-width:2px,color:#000
    classDef gate fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#000
    classDef action fill:#e3f2fd,stroke:#1565c0,stroke-width:1px,color:#000