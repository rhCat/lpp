flowchart TD
    %% L++ Logic CAD Export
    state_idle(["<b>idle</b><br/>Awaiting task"]):::entry
    state_analyzing(["<b>analyzing</b><br/>Root analysis"])
    state_error(["<b>error</b><br/>Error"])
    state_expanding(["<b>expanding</b><br/>Expand sub-features"])
    state_planning(["<b>planning</b><br/>Plan leaf execution"])
    state_building(["<b>building</b><br/>Build tools"])
    state_executing(["<b>executing</b><br/>Execute leaf"])
    state_reflecting(["<b>reflecting</b><br/>Reflect on progress"])
    state_traversing(["<b>traversing</b><br/>Next leaf"])
    state_evaluating(["<b>evaluating</b><br/>Evaluate completion"])
    state_complete(["<b>complete</b><br/>Done"]):::terminal
    act_t_0_0[["init"]]
    state_idle -- "START" --> act_t_0_0
    act_t_0_0 --> state_idle
    gate_t_1_0{{"can_submit?"}}
    state_idle -- "SUBMIT" --> gate_t_1_0
    act_t_1_0[["set_task, analyze_root"]]
    gate_t_1_0 -- True --> act_t_1_0
    act_t_1_0 --> state_analyzing
    gate_t_2_0{{"has_tree, can_expand, no_error?"}}
    state_analyzing -- "DONE" --> gate_t_2_0
    act_t_2_0[["expand"]]
    gate_t_2_0 -- True --> act_t_2_0
    act_t_2_0 --> state_expanding
    gate_t_3_0{{"has_tree, is_atomic, no_error?"}}
    state_analyzing -- "DONE" --> gate_t_3_0
    act_t_3_0[["collect, plan_leaf"]]
    gate_t_3_0 -- True --> act_t_3_0
    act_t_3_0 --> state_planning
    gate_t_4_0{{"has_error?"}}
    state_analyzing -- "DONE" --> gate_t_4_0
    gate_t_4_0 -- True --> state_error
    gate_t_5_0{{"can_expand, no_error?"}}
    state_expanding -- "DONE" --> gate_t_5_0
    act_t_5_0[["expand"]]
    gate_t_5_0 -- True --> act_t_5_0
    act_t_5_0 --> state_expanding
    gate_t_6_0{{"is_atomic, no_error?"}}
    state_expanding -- "DONE" --> gate_t_6_0
    act_t_6_0[["collect, plan_leaf"]]
    gate_t_6_0 -- True --> act_t_6_0
    act_t_6_0 --> state_planning
    gate_t_7_0{{"has_error?"}}
    state_expanding -- "DONE" --> gate_t_7_0
    gate_t_7_0 -- True --> state_error
    gate_t_8_0{{"needs_tools, no_error?"}}
    state_planning -- "DONE" --> gate_t_8_0
    act_t_8_0[["build"]]
    gate_t_8_0 -- True --> act_t_8_0
    act_t_8_0 --> state_building
    gate_t_9_0{{"no_tools, no_error?"}}
    state_planning -- "DONE" --> gate_t_9_0
    act_t_9_0[["exec_leaf"]]
    gate_t_9_0 -- True --> act_t_9_0
    act_t_9_0 --> state_executing
    gate_t_10_0{{"has_error?"}}
    state_planning -- "DONE" --> gate_t_10_0
    gate_t_10_0 -- True --> state_error
    gate_t_11_0{{"needs_tools, no_error?"}}
    state_building -- "DONE" --> gate_t_11_0
    act_t_11_0[["build"]]
    gate_t_11_0 -- True --> act_t_11_0
    act_t_11_0 --> state_building
    gate_t_12_0{{"no_tools, no_error?"}}
    state_building -- "DONE" --> gate_t_12_0
    act_t_12_0[["exec_leaf"]]
    gate_t_12_0 -- True --> act_t_12_0
    act_t_12_0 --> state_executing
    gate_t_13_0{{"has_error?"}}
    state_building -- "DONE" --> gate_t_13_0
    gate_t_13_0 -- True --> state_error
    gate_t_14_0{{"has_more, no_error?"}}
    state_executing -- "DONE" --> gate_t_14_0
    act_t_14_0[["next_leaf"]]
    gate_t_14_0 -- True --> act_t_14_0
    act_t_14_0 --> state_traversing
    gate_t_15_0{{"all_done, no_error?"}}
    state_executing -- "DONE" --> gate_t_15_0
    act_t_15_0[["reflect"]]
    gate_t_15_0 -- True --> act_t_15_0
    act_t_15_0 --> state_reflecting
    gate_t_16_0{{"has_error?"}}
    state_executing -- "DONE" --> gate_t_16_0
    gate_t_16_0 -- True --> state_error
    gate_t_17_0{{"needs_tools, no_error?"}}
    state_traversing -- "DONE" --> gate_t_17_0
    act_t_17_0[["build"]]
    gate_t_17_0 -- True --> act_t_17_0
    act_t_17_0 --> state_building
    gate_t_18_0{{"no_tools, no_error?"}}
    state_traversing -- "DONE" --> gate_t_18_0
    act_t_18_0[["exec_leaf"]]
    gate_t_18_0 -- True --> act_t_18_0
    act_t_18_0 --> state_executing
    gate_t_19_0{{"has_error?"}}
    state_traversing -- "DONE" --> gate_t_19_0
    gate_t_19_0 -- True --> state_error
    gate_t_20_0{{"no_error?"}}
    state_reflecting -- "DONE" --> gate_t_20_0
    act_t_20_0[["evaluate, incr"]]
    gate_t_20_0 -- True --> act_t_20_0
    act_t_20_0 --> state_evaluating
    gate_t_21_0{{"has_error?"}}
    state_reflecting -- "DONE" --> gate_t_21_0
    gate_t_21_0 -- True --> state_error
    gate_t_22_0{{"is_complete, no_error?"}}
    state_evaluating -- "DONE" --> gate_t_22_0
    gate_t_22_0 -- True --> state_complete
    gate_t_23_0{{"not_complete, within_iter, no_error?"}}
    state_evaluating -- "DONE" --> gate_t_23_0
    act_t_23_0[["reset_exec, expand"]]
    gate_t_23_0 -- True --> act_t_23_0
    act_t_23_0 --> state_expanding
    gate_t_24_0{{"max_iter?"}}
    state_evaluating -- "DONE" --> gate_t_24_0
    gate_t_24_0 -- True --> state_complete
    gate_t_25_0{{"has_error?"}}
    state_evaluating -- "DONE" --> gate_t_25_0
    gate_t_25_0 -- True --> state_error
    act_t_26_0[["clear_err"]]
    state_error -- "RETRY" --> act_t_26_0
    act_t_26_0 --> state_idle
    state_idle -- "RESET" --> state_idle
    state_analyzing -- "RESET" --> state_idle
    state_error -- "RESET" --> state_idle
    state_expanding -- "RESET" --> state_idle
    state_planning -- "RESET" --> state_idle
    state_building -- "RESET" --> state_idle
    state_executing -- "RESET" --> state_idle
    state_reflecting -- "RESET" --> state_idle
    state_traversing -- "RESET" --> state_idle
    state_evaluating -- "RESET" --> state_idle
    state_complete -- "RESET" --> state_idle
    classDef entry fill:#e1f5fe,stroke:#01579b,stroke-width:4px
    classDef terminal fill:#eceff1,stroke:#263238,stroke-width:4px