{
  "$schema": "lpp/v0.2.0",
  "id": "lvp_fix_gen",
  "name": "LVP Fix Generation Component",
  "version": "1.0.0",
  "description": "Phase 5: Generate patches and verify with TLAPS",
  "context_schema": {
    "properties": {
      "counter_examples": {
        "type": "array",
        "description": "Counter-examples to fix"
      },
      "bone_json": {
        "type": "object",
        "description": "Original logic blueprint"
      },
      "invariants": {
        "type": "array",
        "description": "Safety invariants"
      },
      "output_dir": {
        "type": "string",
        "description": "Output directory"
      },
      "lpp_root": {
        "type": "string",
        "description": "L++ root path"
      },
      "api_key": {
        "type": "string",
        "description": "LLM API key"
      },
      "api_base": {
        "type": "string",
        "description": "LLM API base"
      },
      "model": {
        "type": "string",
        "description": "LLM model"
      },
      "patches": {
        "type": "array",
        "description": "Generated patches"
      },
      "patched_json": {
        "type": "object",
        "description": "Patched blueprint"
      },
      "tlaps_proof": {
        "type": "string",
        "description": "TLAPS proof"
      },
      "fix_verified": {
        "type": "boolean",
        "description": "Fix verified by TLAPS"
      },
      "error": {
        "type": "string",
        "description": "Error message"
      }
    }
  },
  "states": {
    "idle": {
      "description": "Awaiting fix generation request"
    },
    "generating_patches": {
      "description": "Generating patches"
    },
    "verifying_tlaps": {
      "description": "Verifying with TLAPS"
    },
    "verified": {
      "description": "Fix verified by TLAPS"
    },
    "unverified": {
      "description": "Fix generated but not verified"
    },
    "error": {
      "description": "Fix generation failed"
    }
  },
  "entry_state": "idle",
  "terminal_states": {
    "verified": {
      "output_schema": {
        "patches": {
          "type": "array",
          "non_null": true
        },
        "patched_json": {
          "type": "object",
          "non_null": true
        },
        "tlaps_proof": {
          "type": "string",
          "non_null": true
        },
        "fix_verified": {
          "type": "boolean",
          "non_null": true
        }
      },
      "invariants_guaranteed": [
        "fix_verified"
      ]
    },
    "unverified": {
      "output_schema": {
        "patches": {
          "type": "array",
          "non_null": true
        },
        "patched_json": {
          "type": "object",
          "non_null": true
        },
        "fix_verified": {
          "type": "boolean",
          "non_null": true
        }
      },
      "invariants_guaranteed": [
        "patches_generated"
      ]
    },
    "error": {
      "output_schema": {
        "error": {
          "type": "string",
          "non_null": true
        }
      }
    }
  },
  "gates": {
    "has_counter_examples": {
      "type": "expression",
      "expression": "counter_examples is not None and len(counter_examples) > 0"
    },
    "has_patches": {
      "type": "expression",
      "expression": "patches is not None"
    },
    "fix_verified": {
      "type": "expression",
      "expression": "fix_verified == True"
    },
    "fix_not_verified": {
      "type": "expression",
      "expression": "fix_verified != True"
    },
    "has_error": {
      "type": "expression",
      "expression": "error is not None"
    },
    "no_error": {
      "type": "expression",
      "expression": "error is None"
    }
  },
  "actions": {
    "generate_patches": {
      "type": "compute",
      "compute_unit": "lvp:generate_patches",
      "input_map": {
        "counter_examples": "counter_examples",
        "bone_json": "bone_json",
        "invariants": "invariants",
        "api_key": "api_key",
        "api_base": "api_base",
        "model": "model",
        "output_dir": "output_dir"
      },
      "output_map": {
        "patches": "patches",
        "patched_json": "patched_json",
        "error": "error"
      }
    },
    "verify_fix_tlaps": {
      "type": "compute",
      "compute_unit": "lvp:verify_fix_tlaps",
      "input_map": {
        "patched_json": "patched_json",
        "invariants": "invariants",
        "output_dir": "output_dir",
        "lpp_root": "lpp_root"
      },
      "output_map": {
        "tlaps_proof": "tlaps_proof",
        "fix_verified": "fix_verified",
        "error": "error"
      }
    }
  },
  "transitions": [
    {
      "id": "t_start",
      "from": "idle",
      "to": "generating_patches",
      "on_event": "FIX",
      "gates": [
        "has_counter_examples"
      ],
      "actions": [
        "generate_patches"
      ]
    },
    {
      "id": "t_patches_done",
      "from": "generating_patches",
      "to": "verifying_tlaps",
      "on_event": "CONTINUE",
      "gates": [
        "has_patches",
        "no_error"
      ],
      "actions": [
        "verify_fix_tlaps"
      ]
    },
    {
      "id": "t_patches_error",
      "from": "generating_patches",
      "to": "error",
      "on_event": "CONTINUE",
      "gates": [
        "has_error"
      ]
    },
    {
      "id": "t_verified",
      "from": "verifying_tlaps",
      "to": "verified",
      "on_event": "COMPLETE",
      "gates": [
        "fix_verified",
        "no_error"
      ]
    },
    {
      "id": "t_unverified",
      "from": "verifying_tlaps",
      "to": "unverified",
      "on_event": "COMPLETE",
      "gates": [
        "fix_not_verified"
      ]
    },
    {
      "id": "t_verify_error",
      "from": "verifying_tlaps",
      "to": "error",
      "on_event": "COMPLETE",
      "gates": [
        "has_error"
      ]
    }
  ]
}
