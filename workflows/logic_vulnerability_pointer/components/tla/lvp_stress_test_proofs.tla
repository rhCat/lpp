--------------------------- MODULE lvp_stress_test_proofs ---------------------------
(*
 * L++ Blueprint: LVP Stress Test Component
 * Version: 1.0.0
 * TLAPS Mathematical Proof
 *)

EXTENDS Naturals, TLAPS

CONSTANTS
    STATE_idle, STATE_generating_tla, STATE_running_tlc, STATE_analyzing, STATE_vulnerable, STATE_secure, STATE_error

ASSUME ConstantsDistinct ==
    /\ STATE_idle /= STATE_generating_tla
    /\ STATE_idle /= STATE_running_tlc
    /\ STATE_idle /= STATE_analyzing
    /\ STATE_idle /= STATE_vulnerable
    /\ STATE_idle /= STATE_secure
    /\ STATE_idle /= STATE_error
    /\ STATE_generating_tla /= STATE_running_tlc
    /\ STATE_generating_tla /= STATE_analyzing
    /\ STATE_generating_tla /= STATE_vulnerable
    /\ STATE_generating_tla /= STATE_secure
    /\ STATE_generating_tla /= STATE_error
    /\ STATE_running_tlc /= STATE_analyzing
    /\ STATE_running_tlc /= STATE_vulnerable
    /\ STATE_running_tlc /= STATE_secure
    /\ STATE_running_tlc /= STATE_error
    /\ STATE_analyzing /= STATE_vulnerable
    /\ STATE_analyzing /= STATE_secure
    /\ STATE_analyzing /= STATE_error
    /\ STATE_vulnerable /= STATE_secure
    /\ STATE_vulnerable /= STATE_error
    /\ STATE_secure /= STATE_error

VARIABLE state

vars == <<state>>

States == {STATE_idle, STATE_generating_tla, STATE_running_tlc, STATE_analyzing, STATE_vulnerable, STATE_secure, STATE_error}
TerminalStates == {STATE_vulnerable, STATE_secure, STATE_error}

TypeInvariant == state \in States

Init == state = STATE_idle

(* Transition: t_start *)
t_t_start ==
    /\ state = STATE_idle
    /\ state' = STATE_generating_tla

(* Transition: t_tla_done *)
t_t_tla_done ==
    /\ state = STATE_generating_tla
    /\ state' = STATE_running_tlc

(* Transition: t_tla_error *)
t_t_tla_error ==
    /\ state = STATE_generating_tla
    /\ state' = STATE_error

(* Transition: t_tlc_vuln *)
t_t_tlc_vuln ==
    /\ state = STATE_running_tlc
    /\ state' = STATE_analyzing

(* Transition: t_tlc_secure *)
t_t_tlc_secure ==
    /\ state = STATE_running_tlc
    /\ state' = STATE_secure

(* Transition: t_tlc_error *)
t_t_tlc_error ==
    /\ state = STATE_running_tlc
    /\ state' = STATE_error

(* Transition: t_analyze_done *)
t_t_analyze_done ==
    /\ state = STATE_analyzing
    /\ state' = STATE_vulnerable

(* Transition: t_analyze_error *)
t_t_analyze_error ==
    /\ state = STATE_analyzing
    /\ state' = STATE_error

Next ==
    \/ t_t_start
    \/ t_t_tla_done
    \/ t_t_tla_error
    \/ t_t_tlc_vuln
    \/ t_t_tlc_secure
    \/ t_t_tlc_error
    \/ t_t_analyze_done
    \/ t_t_analyze_error

Spec == Init /\ [][Next]_vars

Inv == TypeInvariant

-----------------------------------------------------------------------------
(* TLAPS Proofs *)

LEMMA InitEstablishesInv == Init => Inv
BY DEF Init, Inv, TypeInvariant, States

LEMMA StartPreservesInv == Inv /\ t_t_start => Inv'
BY ConstantsDistinct DEF Inv, t_t_start, TypeInvariant, States

LEMMA TlaDonePreservesInv == Inv /\ t_t_tla_done => Inv'
BY ConstantsDistinct DEF Inv, t_t_tla_done, TypeInvariant, States

LEMMA TlaErrorPreservesInv == Inv /\ t_t_tla_error => Inv'
BY ConstantsDistinct DEF Inv, t_t_tla_error, TypeInvariant, States

LEMMA TlcVulnPreservesInv == Inv /\ t_t_tlc_vuln => Inv'
BY ConstantsDistinct DEF Inv, t_t_tlc_vuln, TypeInvariant, States

LEMMA TlcSecurePreservesInv == Inv /\ t_t_tlc_secure => Inv'
BY ConstantsDistinct DEF Inv, t_t_tlc_secure, TypeInvariant, States

LEMMA TlcErrorPreservesInv == Inv /\ t_t_tlc_error => Inv'
BY ConstantsDistinct DEF Inv, t_t_tlc_error, TypeInvariant, States

LEMMA AnalyzeDonePreservesInv == Inv /\ t_t_analyze_done => Inv'
BY ConstantsDistinct DEF Inv, t_t_analyze_done, TypeInvariant, States

LEMMA AnalyzeErrorPreservesInv == Inv /\ t_t_analyze_error => Inv'
BY ConstantsDistinct DEF Inv, t_t_analyze_error, TypeInvariant, States

LEMMA StutterPreservesInv == Inv /\ UNCHANGED vars => Inv'
BY DEF Inv, vars, TypeInvariant

LEMMA NextPreservesInv == Inv /\ Next => Inv'
BY StartPreservesInv, TlaDonePreservesInv, TlaErrorPreservesInv, TlcVulnPreservesInv, TlcSecurePreservesInv, TlcErrorPreservesInv, AnalyzeDonePreservesInv, AnalyzeErrorPreservesInv DEF Next

THEOREM InductiveInvariant == Inv /\ [Next]_vars => Inv'
BY NextPreservesInv, StutterPreservesInv DEF vars

THEOREM TypeSafety == Spec => []Inv
<1>1. Init => Inv
  BY InitEstablishesInv
<1>2. Inv /\ [Next]_vars => Inv'
  BY InductiveInvariant
<1>3. QED
  BY <1>1, <1>2, PTL DEF Spec

=============================================================================