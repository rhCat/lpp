---------------------------- MODULE logic_vulnerability_pointer ----------------------------
\* L++ Blueprint: Logic Vulnerability Pointer (LVP)
\* Version: 1.0.0
\* Auto-generated TLA+ specification (universal adaptor)

EXTENDS Integers, Sequences, TLC

\* =========================================================
\* BOUNDS - Constrain state space for model checking
\* =========================================================
INT_MIN == -10
INT_MAX == 10
MAX_HISTORY == 5
BoundedInt == INT_MIN..INT_MAX

\* NULL constant for uninitialized values
CONSTANT NULL

\* States
States == {"idle", "xray", "threat_modeling", "stress_testing", "analyzing_traces", "exploit_generation", "generating_fix", "verifying_fix", "reporting", "complete", "secure", "error"}

Events == {"AUDIT", "DONE", "RESET", "RETRY", "START"}

TerminalStates == {"complete", "secure", "error"}

VARIABLES
    state,           \* Current state
    target_path,           \* Path to target Python file/project to audit
    target_name,           \* Name of the target for reports
    output_dir,           \* Directory for audit artifacts
    run_id,           \* Unique audit run identifier
    bone_json,           \* Phase 1: Extracted logic blueprint (the 'Bone')
    bone_path,           \* Path to saved bone JSON file
    extraction_error,           \* Error during logic extraction
    invariants,           \* Phase 2: Safety invariants to verify
    threat_model,           \* Threat model with attack vectors and invariants
    invariant_count,           \* Number of invariants defined
    tla_spec,           \* Phase 3: Generated TLA+ specification
    tla_path,           \* Path to TLA+ spec file
    tlc_result,           \* TLC model checker result
    counter_examples,           \* Counter-example traces found by TLC
    vulnerability_count,           \* Number of vulnerabilities found
    exploits,           \* Phase 4: Generated exploit/trigger scripts
    exploit_paths,           \* Paths to exploit script files
    poc_generated,           \* True if PoC scripts were generated
    patches,           \* Phase 5: Suggested patches
    patched_json,           \* Patched logic blueprint with gates
    tlaps_proof,           \* TLAPS proof of fix correctness
    fix_verified,           \* True if fix passed TLAPS verification
    audit_report,           \* Final audit report
    severity_score,           \* Overall severity score 0-10
    phase,           \* Current audit phase: xray|threat|stress|exploit|fix
    error,           \* Error message if any
    api_key,           \* LLM API key for threat modeling
    api_base,           \* LLM API base URL
    model,           \* LLM model identifier
    lpp_root,           \* Root path of L++ framework
    auto_fix,           \* Auto-generate fixes if vulnerabilities found
    event_history    \* Trace of events

vars == <<state, target_path, target_name, output_dir, run_id, bone_json, bone_path, extraction_error, invariants, threat_model, invariant_count, tla_spec, tla_path, tlc_result, counter_examples, vulnerability_count, exploits, exploit_paths, poc_generated, patches, patched_json, tlaps_proof, fix_verified, audit_report, severity_score, phase, error, api_key, api_base, model, lpp_root, auto_fix, event_history>>

\* Type invariant - structural correctness
TypeInvariant ==
    /\ state \in States
    /\ TRUE  \* target_path: any string or NULL
    /\ TRUE  \* target_name: any string or NULL
    /\ TRUE  \* output_dir: any string or NULL
    /\ TRUE  \* run_id: any string or NULL
    /\ TRUE  \* bone_json: any string or NULL
    /\ TRUE  \* bone_path: any string or NULL
    /\ TRUE  \* extraction_error: any string or NULL
    /\ TRUE  \* invariants: any string or NULL
    /\ TRUE  \* threat_model: any string or NULL
    /\ (invariant_count \in BoundedInt) \/ (invariant_count = NULL)
    /\ TRUE  \* tla_spec: any string or NULL
    /\ TRUE  \* tla_path: any string or NULL
    /\ TRUE  \* tlc_result: any string or NULL
    /\ TRUE  \* counter_examples: any string or NULL
    /\ (vulnerability_count \in BoundedInt) \/ (vulnerability_count = NULL)
    /\ TRUE  \* exploits: any string or NULL
    /\ TRUE  \* exploit_paths: any string or NULL
    /\ (poc_generated \in BOOLEAN) \/ (poc_generated = NULL)
    /\ TRUE  \* patches: any string or NULL
    /\ TRUE  \* patched_json: any string or NULL
    /\ TRUE  \* tlaps_proof: any string or NULL
    /\ (fix_verified \in BOOLEAN) \/ (fix_verified = NULL)
    /\ TRUE  \* audit_report: any string or NULL
    /\ (severity_score \in BoundedInt) \/ (severity_score = NULL)
    /\ TRUE  \* phase: any string or NULL
    /\ TRUE  \* error: any string or NULL
    /\ TRUE  \* api_key: any string or NULL
    /\ TRUE  \* api_base: any string or NULL
    /\ TRUE  \* model: any string or NULL
    /\ TRUE  \* lpp_root: any string or NULL
    /\ (auto_fix \in BOOLEAN) \/ (auto_fix = NULL)

\* State constraint - limits TLC exploration depth
StateConstraint ==
    /\ Len(event_history) <= MAX_HISTORY
    /\ (invariant_count = NULL) \/ (invariant_count \in BoundedInt)
    /\ (vulnerability_count = NULL) \/ (vulnerability_count \in BoundedInt)
    /\ (severity_score = NULL) \/ (severity_score \in BoundedInt)

\* Initial state
Init ==
    /\ state = "idle"
    /\ target_path = NULL
    /\ target_name = NULL
    /\ output_dir = NULL
    /\ run_id = NULL
    /\ bone_json = NULL
    /\ bone_path = NULL
    /\ extraction_error = NULL
    /\ invariants = NULL
    /\ threat_model = NULL
    /\ invariant_count = NULL
    /\ tla_spec = NULL
    /\ tla_path = NULL
    /\ tlc_result = NULL
    /\ counter_examples = NULL
    /\ vulnerability_count = NULL
    /\ exploits = NULL
    /\ exploit_paths = NULL
    /\ poc_generated = NULL
    /\ patches = NULL
    /\ patched_json = NULL
    /\ tlaps_proof = NULL
    /\ fix_verified = NULL
    /\ audit_report = NULL
    /\ severity_score = NULL
    /\ phase = NULL
    /\ error = NULL
    /\ api_key = NULL
    /\ api_base = NULL
    /\ model = NULL
    /\ lpp_root = NULL
    /\ auto_fix = NULL
    /\ event_history = <<>>

\* Transitions
\* t_start: idle --(START)--> idle
t_start ==
    /\ state = "idle"
    /\ state' = "idle"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "START")

\* t_audit: idle --(AUDIT)--> xray
t_audit ==
    /\ state = "idle"
    /\ target_path /= NULL /\ Len(target_path) > 0  \* gate: has_target
    /\ state' = "xray"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "AUDIT")

\* t_audit_no_target: idle --(AUDIT)--> error
t_audit_no_target ==
    /\ state = "idle"
    /\ target_path = NULL \/ Len(target_path) = 0  \* gate: no_target
    /\ state' = "error"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "AUDIT")

\* t_xray_done: xray --(DONE)--> threat_modeling
t_xray_done ==
    /\ state = "xray"
    /\ bone_json /= NULL  \* gate: has_bone
    /\ error = NULL  \* gate: no_error
    /\ state' = "threat_modeling"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "DONE")

\* t_xray_error: xray --(DONE)--> error
t_xray_error ==
    /\ state = "xray"
    /\ error /= NULL  \* gate: has_error
    /\ state' = "error"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "DONE")

\* t_threat_done: threat_modeling --(DONE)--> stress_testing
t_threat_done ==
    /\ state = "threat_modeling"
    /\ invariants /= NULL /\ Len(invariants) > 0  \* gate: has_invariants
    /\ error = NULL  \* gate: no_error
    /\ state' = "stress_testing"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "DONE")

\* t_threat_error: threat_modeling --(DONE)--> error
t_threat_error ==
    /\ state = "threat_modeling"
    /\ error /= NULL  \* gate: has_error
    /\ state' = "error"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "DONE")

\* t_stress_vuln_found: stress_testing --(DONE)--> analyzing_traces
t_stress_vuln_found ==
    /\ state = "stress_testing"
    /\ counter_examples /= NULL /\ Len(counter_examples) > 0  \* gate: has_counter_examples
    /\ error = NULL  \* gate: no_error
    /\ state' = "analyzing_traces"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "DONE")

\* t_stress_secure: stress_testing --(DONE)--> secure
t_stress_secure ==
    /\ state = "stress_testing"
    /\ counter_examples = NULL \/ Len(counter_examples) = 0  \* gate: no_counter_examples
    /\ error = NULL  \* gate: no_error
    /\ state' = "secure"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "DONE")

\* t_stress_error: stress_testing --(DONE)--> error
t_stress_error ==
    /\ state = "stress_testing"
    /\ error /= NULL  \* gate: has_error
    /\ state' = "error"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "DONE")

\* t_analyze_done: analyzing_traces --(DONE)--> exploit_generation
t_analyze_done ==
    /\ state = "analyzing_traces"
    /\ error = NULL  \* gate: no_error
    /\ state' = "exploit_generation"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "DONE")

\* t_analyze_error: analyzing_traces --(DONE)--> error
t_analyze_error ==
    /\ state = "analyzing_traces"
    /\ error /= NULL  \* gate: has_error
    /\ state' = "error"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "DONE")

\* t_exploit_to_fix: exploit_generation --(DONE)--> generating_fix
t_exploit_to_fix ==
    /\ state = "exploit_generation"
    /\ exploits /= NULL /\ Len(exploits) > 0  \* gate: has_exploits
    /\ auto_fix = TRUE  \* gate: auto_fix_enabled
    /\ error = NULL  \* gate: no_error
    /\ state' = "generating_fix"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "DONE")

\* t_exploit_to_report: exploit_generation --(DONE)--> reporting
t_exploit_to_report ==
    /\ state = "exploit_generation"
    /\ exploits /= NULL /\ Len(exploits) > 0  \* gate: has_exploits
    /\ auto_fix /= TRUE  \* gate: auto_fix_disabled
    /\ error = NULL  \* gate: no_error
    /\ state' = "reporting"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "DONE")

\* t_exploit_error: exploit_generation --(DONE)--> error
t_exploit_error ==
    /\ state = "exploit_generation"
    /\ error /= NULL  \* gate: has_error
    /\ state' = "error"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "DONE")

\* t_fix_verify: generating_fix --(DONE)--> verifying_fix
t_fix_verify ==
    /\ state = "generating_fix"
    /\ patches /= NULL /\ Len(patches) > 0  \* gate: has_patches
    /\ error = NULL  \* gate: no_error
    /\ state' = "verifying_fix"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "DONE")

\* t_fix_error: generating_fix --(DONE)--> reporting
t_fix_error ==
    /\ state = "generating_fix"
    /\ error /= NULL  \* gate: has_error
    /\ state' = "reporting"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "DONE")

\* t_verify_done: verifying_fix --(DONE)--> reporting
t_verify_done ==
    /\ state = "verifying_fix"
    /\ error = NULL  \* gate: no_error
    /\ state' = "reporting"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "DONE")

\* t_verify_error: verifying_fix --(DONE)--> reporting
t_verify_error ==
    /\ state = "verifying_fix"
    /\ error /= NULL  \* gate: has_error
    /\ state' = "reporting"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "DONE")

\* t_report_done: reporting --(DONE)--> complete
t_report_done ==
    /\ state = "reporting"
    /\ error = NULL  \* gate: no_error
    /\ state' = "complete"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "DONE")

\* t_report_error: reporting --(DONE)--> error
t_report_error ==
    /\ state = "reporting"
    /\ error /= NULL  \* gate: has_error
    /\ state' = "error"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "DONE")

\* t_reset: * --(RESET)--> idle
t_reset ==
    /\ TRUE  \* from any state
    /\ state' = "idle"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "RESET")

\* t_error_retry: error --(RETRY)--> idle
t_error_retry ==
    /\ state = "error"
    /\ state' = "idle"
    /\ target_path' = target_path
    /\ target_name' = target_name
    /\ output_dir' = output_dir
    /\ run_id' = run_id
    /\ bone_json' = bone_json
    /\ bone_path' = bone_path
    /\ extraction_error' = extraction_error
    /\ invariants' = invariants
    /\ threat_model' = threat_model
    /\ invariant_count' = invariant_count
    /\ tla_spec' = tla_spec
    /\ tla_path' = tla_path
    /\ tlc_result' = tlc_result
    /\ counter_examples' = counter_examples
    /\ vulnerability_count' = vulnerability_count
    /\ exploits' = exploits
    /\ exploit_paths' = exploit_paths
    /\ poc_generated' = poc_generated
    /\ patches' = patches
    /\ patched_json' = patched_json
    /\ tlaps_proof' = tlaps_proof
    /\ fix_verified' = fix_verified
    /\ audit_report' = audit_report
    /\ severity_score' = severity_score
    /\ phase' = phase
    /\ error' = error
    /\ api_key' = api_key
    /\ api_base' = api_base
    /\ model' = model
    /\ lpp_root' = lpp_root
    /\ auto_fix' = auto_fix
    /\ event_history' = Append(event_history, "RETRY")

\* Next state relation
Next ==
    \/ t_start
    \/ t_audit
    \/ t_audit_no_target
    \/ t_xray_done
    \/ t_xray_error
    \/ t_threat_done
    \/ t_threat_error
    \/ t_stress_vuln_found
    \/ t_stress_secure
    \/ t_stress_error
    \/ t_analyze_done
    \/ t_analyze_error
    \/ t_exploit_to_fix
    \/ t_exploit_to_report
    \/ t_exploit_error
    \/ t_fix_verify
    \/ t_fix_error
    \/ t_verify_done
    \/ t_verify_error
    \/ t_report_done
    \/ t_report_error
    \/ t_reset
    \/ t_error_retry

\* Specification
Spec == Init /\ [][Next]_vars

\* Safety: Always in valid state
AlwaysValidState == state \in States

\* Reachability: Entry state is reachable
EntryReachable == state = "idle"

\* Terminal states are reachable
TerminalReachable == <>(state = "complete" \/ state = "secure" \/ state = "error")

=============================================================================